From 948872e41fde33bbb12f65ebbf658b85f13c3e95 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Mon, 10 Nov 2025 12:28:05 +0000
Subject: [PATCH] Refactor: Remove transformation logic, add phone_code support

Database Migration:
- Add phone_code VARCHAR(4) column to t_user_invitations
- Store both country_code ('IN') and phone_code ('91')

Edge Function Simplification:
- Remove COUNTRY_PHONE_CODES mapping (moved to UI)
- Remove formatInternationalPhone() helper function
- Accept phone_code directly from UI
- Simply combine: +${phone_code}${mobile_number}
- NO transformation or lookup needed

Architecture: UI does transformation, edge function just uses data.
This is cleaner, faster, and follows single responsibility principle.
---
 supabase/functions/user-invitations/index.ts  | 41 ++++---------------
 ...251110_add_country_code_to_invitations.sql | 11 +++--
 2 files changed, 16 insertions(+), 36 deletions(-)

diff --git a/supabase/functions/user-invitations/index.ts b/supabase/functions/user-invitations/index.ts
index d68e54e..4ccec81 100644
--- a/supabase/functions/user-invitations/index.ts
+++ b/supabase/functions/user-invitations/index.ts
@@ -10,34 +10,6 @@ const corsHeaders = {
  'Access-Control-Allow-Methods': 'GET, POST, PUT, PATCH, DELETE, OPTIONS'
 };
 
-// Country code to phone code mapping (ISO 3166-1 alpha-2 to phone dialing code)
-const COUNTRY_PHONE_CODES: Record<string, string> = {
-  'IN': '91', 'US': '1', 'GB': '44', 'AE': '971', 'SG': '65', 'AU': '61',
-  'CA': '1', 'DE': '49', 'FR': '33', 'ES': '34', 'IT': '39', 'NL': '31',
-  'CH': '41', 'AT': '43', 'BE': '32', 'SE': '46', 'NO': '47', 'DK': '45',
-  'FI': '358', 'PL': '48', 'PT': '351', 'IE': '353', 'NZ': '64', 'ZA': '27',
-  'BR': '55', 'MX': '52', 'AR': '54', 'CL': '56', 'CO': '57', 'PE': '51',
-  'CN': '86', 'JP': '81', 'KR': '82', 'TW': '886', 'HK': '852', 'MY': '60',
-  'TH': '66', 'ID': '62', 'PH': '63', 'VN': '84', 'SA': '966', 'IL': '972',
-  'TR': '90', 'EG': '20', 'RU': '7', 'UA': '380', 'PK': '92', 'BD': '880'
-};
-
-// Helper function to format international phone number
-function formatInternationalPhone(countryCode: string | null, mobileNumber: string | null): string | null {
-  if (!mobileNumber) return null;
-  if (!countryCode) return mobileNumber; // Return as-is if no country code
-
-  const phoneCode = COUNTRY_PHONE_CODES[countryCode.toUpperCase()];
-  if (!phoneCode) {
-    console.warn(`Unknown country code: ${countryCode}, using mobile number as-is`);
-    return mobileNumber;
-  }
-
-  // Clean mobile number (remove non-digits)
-  const cleanMobile = mobileNumber.replace(/\D/g, '');
-  return `+${phoneCode}${cleanMobile}`;
-}
-
 serve(async (req) => {
  // Handle CORS preflight request
  if (req.method === 'OPTIONS') {
@@ -335,7 +307,7 @@ async function getInvitation(supabase: any, tenantId: string, invitationId: stri
 // Create new invitation
 async function createInvitation(supabase: any, tenantId: string, userId: string, body: any) {
  try {
-   const { email, mobile_number, country_code, invitation_method, role_id, custom_message } = body;
+   const { email, mobile_number, country_code, phone_code, invitation_method, role_id, custom_message } = body;
    
    // Validate input
    if (!email && !mobile_number) {
@@ -406,6 +378,7 @@ async function createInvitation(supabase: any, tenantId: string, userId: string,
      email: email || null,
      mobile_number: mobile_number || null,
      country_code: country_code || null,
+     phone_code: phone_code || null,
      invitation_method: invitation_method || 'email',
      status: 'pending',
      created_by: userId,
@@ -466,17 +439,19 @@ async function createInvitation(supabase: any, tenantId: string, userId: string,
          customMessage: custom_message
        });
      } else if (invitation_method === 'sms' && mobile_number) {
-       const internationalPhoneSMS = formatInternationalPhone(country_code, mobile_number);
+       // Simply combine phone_code + mobile_number (no transformation)
+       const internationalPhone = phone_code ? `+${phone_code}${mobile_number}` : mobile_number;
        sendSuccess = await sendInvitationSMS({
-         to: internationalPhoneSMS,
+         to: internationalPhone,
          inviterName: `${inviterProfile?.first_name || 'Someone'}`,
          workspaceName: tenant?.name || 'Workspace',
          invitationLink
        });
      } else if (invitation_method === 'whatsapp' && mobile_number) {
-       const internationalPhoneWA = formatInternationalPhone(country_code, mobile_number);
+       // Simply combine phone_code + mobile_number (no transformation)
+       const internationalPhone = phone_code ? `+${phone_code}${mobile_number}` : mobile_number;
        sendSuccess = await sendInvitationWhatsApp({
-         to: internationalPhoneWA,
+         to: internationalPhone,
          inviterName: `${inviterProfile?.first_name || 'Someone'} ${inviterProfile?.last_name || ''}`.trim(),
          workspaceName: tenant?.name || 'Workspace',
          invitationLink,
diff --git a/supabase/migrations/20251110_add_country_code_to_invitations.sql b/supabase/migrations/20251110_add_country_code_to_invitations.sql
index a169e4d..d060c75 100644
--- a/supabase/migrations/20251110_add_country_code_to_invitations.sql
+++ b/supabase/migrations/20251110_add_country_code_to_invitations.sql
@@ -1,13 +1,18 @@
--- Migration: Add country_code column to t_user_invitations table
+-- Migration: Add country_code and phone_code columns to t_user_invitations table
 -- Date: 2025-11-10
--- Description: Add country_code (ISO 2-letter code) to store country information separately from mobile_number
+-- Description: Add country_code (ISO 2-letter code) and phone_code (dialing code) to store country information separately from mobile_number
 
 -- Add country_code column
 ALTER TABLE t_user_invitations
 ADD COLUMN IF NOT EXISTS country_code VARCHAR(2) NULL;
 
--- Add comment for documentation
+-- Add phone_code column
+ALTER TABLE t_user_invitations
+ADD COLUMN IF NOT EXISTS phone_code VARCHAR(4) NULL;
+
+-- Add comments for documentation
 COMMENT ON COLUMN t_user_invitations.country_code IS 'ISO 3166-1 alpha-2 country code (e.g., IN, US, GB)';
+COMMENT ON COLUMN t_user_invitations.phone_code IS 'International dialing code (e.g., 91, 1, 44)';
 
 -- Create index for faster lookups if needed
 CREATE INDEX IF NOT EXISTS idx_user_invitations_country_code ON t_user_invitations(country_code);
-- 
2.43.0

