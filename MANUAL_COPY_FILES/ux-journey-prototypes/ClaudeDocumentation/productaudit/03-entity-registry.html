<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ContractNest — Entity / Property Registration [P2]</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ============================================
   DESIGN SYSTEM — Shared across all 6 files
   ============================================ */
:root {
  --cn-primary: #1e3a5f; --cn-primary-light: #2d5a8e; --cn-primary-50: #eef4fb; --cn-primary-100: #d4e4f7;
  --cn-accent: #f97316; --cn-equipment: #d97706; --cn-equipment-bg: #fffbeb; --cn-equipment-border: #fde68a;
  --cn-entity: #059669; --cn-entity-bg: #ecfdf5; --cn-entity-border: #a7f3d0;
  --cn-good: #10b981; --cn-fair: #f59e0b; --cn-poor: #ef4444; --cn-critical: #dc2626;
  --cn-bg: #f8fafc; --cn-surface: #ffffff; --cn-border: #e2e8f0; --cn-border-light: #f1f5f9;
  --cn-text: #0f172a; --cn-text-secondary: #475569; --cn-text-muted: #94a3b8;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.04);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.04);
  --radius-sm: 6px; --radius-md: 10px; --radius-lg: 14px; --radius-xl: 20px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--cn-bg); color: var(--cn-text); line-height: 1.5; -webkit-font-smoothing: antialiased; overflow: hidden; height: 100vh; }

/* Phase Badge — Green gradient for Entity */
.phase-badge { position: fixed; top: 20px; right: 20px; z-index: 1000; background: linear-gradient(135deg, var(--cn-entity), #047857); color: white; padding: 8px 18px; border-radius: 30px; font-size: 13px; font-weight: 700; letter-spacing: 0.5px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 6px; }
.phase-badge::before { content: ''; width: 8px; height: 8px; background: #6ee7b7; border-radius: 50%; animation: pulse-dot 2s infinite; }
@keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* Journey Map Button */
.journey-map-btn { position: fixed; bottom: 24px; right: 24px; z-index: 1000; background: var(--cn-surface); border: 1px solid var(--cn-border); border-radius: var(--radius-lg); padding: 12px 20px; font-size: 13px; font-weight: 600; color: var(--cn-text); cursor: pointer; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 8px; transition: all 0.2s; font-family: inherit; }
.journey-map-btn:hover { box-shadow: var(--shadow-xl); transform: translateY(-2px); }

/* ============================================
   APP SHELL — Two-panel layout
   ============================================ */
.app-shell { display: flex; height: 100vh; overflow: hidden; }

/* LEFT PANEL — Hierarchy tree */
.left-panel { width: 360px; min-width: 360px; background: var(--cn-surface); border-right: 1px solid var(--cn-border); display: flex; flex-direction: column; overflow: hidden; }
.left-header { padding: 20px 20px 0; }
.left-header .campus-label { font-size: 11px; font-weight: 700; color: var(--cn-text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; }
.left-header .campus-name { font-size: 16px; font-weight: 800; color: var(--cn-text); margin-bottom: 4px; letter-spacing: -0.3px; }
.left-header .campus-sub { font-size: 12px; color: var(--cn-text-muted); margin-bottom: 16px; }
.left-actions { display: flex; gap: 8px; padding: 0 20px 14px; }
.add-entity-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 9px 14px; background: linear-gradient(135deg, var(--cn-entity), #047857); color: white; border: none; border-radius: var(--radius-md); font-size: 12px; font-weight: 700; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.add-entity-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
.tree-search { flex: 1; padding: 8px 12px; border: 1px solid var(--cn-border); border-radius: var(--radius-sm); font-size: 12px; font-family: inherit; background: var(--cn-bg); }
.tree-search:focus { outline: none; border-color: var(--cn-entity); box-shadow: 0 0 0 3px rgba(5,150,105,0.08); }

/* Tree container */
.tree-container { flex: 1; overflow-y: auto; padding: 4px 12px 20px; }
.tree-container::-webkit-scrollbar { width: 5px; }
.tree-container::-webkit-scrollbar-thumb { background: var(--cn-border); border-radius: 4px; }

/* Tree node */
.tree-node { user-select: none; }
.tree-row { display: flex; align-items: center; gap: 4px; padding: 6px 8px; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; position: relative; }
.tree-row:hover { background: var(--cn-bg); }
.tree-row.selected { background: var(--cn-entity-bg); }
.tree-row.selected .tree-name { color: var(--cn-entity); font-weight: 700; }
.tree-arrow { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--cn-text-muted); transition: transform 0.2s; flex-shrink: 0; border-radius: 4px; }
.tree-arrow:hover { background: var(--cn-border); }
.tree-arrow.expanded { transform: rotate(90deg); }
.tree-arrow.empty { visibility: hidden; }
.tree-icon { font-size: 14px; flex-shrink: 0; width: 20px; text-align: center; }
.tree-name { font-size: 12px; font-weight: 500; color: var(--cn-text); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tree-badge { font-size: 10px; font-weight: 600; color: var(--cn-text-muted); background: var(--cn-bg); padding: 1px 7px; border-radius: 8px; flex-shrink: 0; white-space: nowrap; }
.tree-row.selected .tree-badge { background: rgba(5,150,105,0.12); color: var(--cn-entity); }
.tree-condition { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.tree-condition.good { background: var(--cn-good); }
.tree-condition.fair { background: var(--cn-fair); }
.tree-condition.poor { background: var(--cn-poor); }
.tree-children { overflow: hidden; transition: max-height 0.3s ease; }
.tree-children.collapsed { max-height: 0 !important; }

/* Indent levels */
.indent-0 .tree-row { padding-left: 8px; }
.indent-1 .tree-row { padding-left: 24px; }
.indent-2 .tree-row { padding-left: 42px; }
.indent-3 .tree-row { padding-left: 60px; }

/* ============================================
   RIGHT PANEL — Detail + Schematic
   ============================================ */
.right-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--cn-bg); }
.right-scroll { flex: 1; overflow-y: auto; padding: 28px 32px; }
.right-scroll::-webkit-scrollbar { width: 6px; }
.right-scroll::-webkit-scrollbar-thumb { background: var(--cn-border); border-radius: 4px; }

/* Entity header */
.entity-header { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 24px; animation: fadeInUp 0.4s ease; }
.condition-ring { position: relative; width: 72px; height: 72px; flex-shrink: 0; }
.condition-ring svg { width: 72px; height: 72px; transform: rotate(-90deg); }
.condition-ring .ring-bg { fill: none; stroke: var(--cn-border); stroke-width: 5; }
.condition-ring .ring-fg { fill: none; stroke-width: 5; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }
.condition-ring .ring-score { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 18px; font-weight: 800; color: var(--cn-text); line-height: 1; }
.condition-ring .ring-label { font-size: 8px; font-weight: 600; color: var(--cn-text-muted); text-transform: uppercase; margin-top: 2px; letter-spacing: 0.3px; }
.entity-info { flex: 1; }
.entity-info .entity-title-row { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; flex-wrap: wrap; }
.entity-info h1 { font-size: 22px; font-weight: 800; color: var(--cn-text); letter-spacing: -0.3px; }
.type-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; background: var(--cn-entity-bg); color: var(--cn-entity); border: 1px solid var(--cn-entity-border); }
.entity-info .breadcrumb-path { font-size: 12px; color: var(--cn-text-muted); }

/* Detail cards */
.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; animation: fadeInUp 0.45s ease; }
.detail-card { background: var(--cn-surface); border: 1px solid var(--cn-border); border-radius: var(--radius-lg); padding: 18px 20px; }
.detail-card h3 { font-size: 11px; font-weight: 700; color: var(--cn-text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 14px; display: flex; align-items: center; gap: 6px; }
.detail-card h3 .card-icon { font-size: 13px; }
.detail-kv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 16px; }
.detail-kv { display: flex; flex-direction: column; gap: 2px; }
.detail-kv .kv-label { font-size: 10px; font-weight: 600; color: var(--cn-text-muted); text-transform: uppercase; letter-spacing: 0.4px; }
.detail-kv .kv-value { font-size: 13px; font-weight: 600; color: var(--cn-text); }

/* Contract coverage */
.contract-coverage { background: var(--cn-surface); border: 1px solid var(--cn-border); border-radius: var(--radius-lg); padding: 18px 20px; margin-bottom: 24px; animation: fadeInUp 0.5s ease; }
.contract-coverage h3 { font-size: 11px; font-weight: 700; color: var(--cn-text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px; }
.coverage-row { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: #ecfdf5; border: 1px solid var(--cn-entity-border); border-radius: var(--radius-md); }
.coverage-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--cn-good); flex-shrink: 0; animation: pulse-dot 2s infinite; }
.coverage-info { flex: 1; }
.coverage-info .cov-title { font-size: 13px; font-weight: 700; color: var(--cn-text); }
.coverage-info .cov-sub { font-size: 11px; color: var(--cn-text-secondary); margin-top: 1px; }
.coverage-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; background: #d1fae5; color: var(--cn-good); }

/* Inspection history */
.inspection-card { background: var(--cn-surface); border: 1px solid var(--cn-border); border-radius: var(--radius-lg); padding: 18px 20px; margin-bottom: 24px; animation: fadeInUp 0.55s ease; }
.inspection-card h3 { font-size: 11px; font-weight: 700; color: var(--cn-text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 14px; display: flex; align-items: center; gap: 6px; }
.timeline { position: relative; padding-left: 24px; }
.timeline::before { content: ''; position: absolute; left: 7px; top: 6px; bottom: 6px; width: 2px; background: var(--cn-border); border-radius: 2px; }
.timeline-item { position: relative; padding-bottom: 18px; }
.timeline-item:last-child { padding-bottom: 0; }
.timeline-dot { position: absolute; left: -21px; top: 4px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--cn-surface); }
.timeline-dot.good { background: var(--cn-good); }
.timeline-dot.fair { background: var(--cn-fair); }
.timeline-dot.poor { background: var(--cn-poor); }
.timeline-date { font-size: 11px; font-weight: 600; color: var(--cn-text-muted); margin-bottom: 2px; }
.timeline-desc { font-size: 12px; font-weight: 500; color: var(--cn-text-secondary); }
.timeline-score { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px; margin-left: 8px; }
.timeline-score.good { background: #d1fae5; color: var(--cn-good); }
.timeline-score.fair { background: #fef3c7; color: var(--cn-fair); }

/* ============================================
   SCHEMATIC PROPERTY MAP
   ============================================ */
.schematic-section { background: var(--cn-surface); border: 1px solid var(--cn-border); border-radius: var(--radius-lg); padding: 18px 20px; margin-bottom: 24px; animation: fadeInUp 0.6s ease; }
.schematic-section h3 { font-size: 11px; font-weight: 700; color: var(--cn-text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 16px; display: flex; align-items: center; gap: 6px; }
.schematic-label { font-size: 12px; font-weight: 700; color: var(--cn-text); margin-bottom: 12px; }
.building-stack { display: flex; flex-direction: column-reverse; gap: 4px; max-width: 520px; }
.floor-bar { display: flex; align-items: stretch; border-radius: var(--radius-sm); overflow: hidden; border: 2px solid transparent; transition: all 0.2s; min-height: 42px; position: relative; }
.floor-bar.selected-entity { border-color: var(--cn-primary); box-shadow: 0 0 0 2px rgba(30,58,95,0.15); }
.floor-label { width: 90px; min-width: 90px; padding: 6px 10px; font-size: 10px; font-weight: 700; color: var(--cn-text-secondary); display: flex; align-items: center; background: var(--cn-bg); border-right: 1px solid var(--cn-border-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.floor-rooms { flex: 1; display: flex; gap: 3px; padding: 4px; }
.room-block { flex: 1; min-width: 40px; border-radius: 4px; padding: 5px 6px; font-size: 9px; font-weight: 600; cursor: pointer; transition: all 0.15s; text-align: center; display: flex; align-items: center; justify-content: center; position: relative; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.room-block:hover { transform: scale(1.04); z-index: 2; }
.room-block.good-tint { background: #d1fae5; color: #065f46; }
.room-block.fair-tint { background: #fef3c7; color: #92400e; }
.room-block.poor-tint { background: #fee2e2; color: #991b1b; }
.room-block.selected-room { outline: 2px solid var(--cn-primary); outline-offset: -1px; }
.floor-bar.good-floor { background: #f0fdf4; }
.floor-bar.fair-floor { background: #fffbeb; }
.floor-bar.poor-floor { background: #fef2f2; }

/* Room tooltip */
.room-tooltip { position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--cn-text); color: white; font-size: 11px; font-weight: 600; padding: 5px 10px; border-radius: var(--radius-sm); white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.15s; z-index: 100; }
.room-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 5px solid transparent; border-top-color: var(--cn-text); }
.room-block:hover .room-tooltip { opacity: 1; }

/* Schematic legend */
.schematic-legend { display: flex; gap: 16px; margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--cn-border-light); }
.legend-item { display: flex; align-items: center; gap: 5px; font-size: 10px; font-weight: 600; color: var(--cn-text-muted); }
.legend-swatch { width: 12px; height: 12px; border-radius: 3px; }

/* ============================================
   BULK CREATION CARD
   ============================================ */
.bulk-card { background: var(--cn-surface); border: 1px solid var(--cn-border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 24px; animation: fadeInUp 0.65s ease; }
.bulk-card h3 { font-size: 13px; font-weight: 700; color: var(--cn-text); margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
.bulk-card .bulk-sub { font-size: 12px; color: var(--cn-text-secondary); margin-bottom: 16px; }
.bulk-input-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 14px; flex-wrap: wrap; }
.bulk-field { display: flex; flex-direction: column; gap: 4px; }
.bulk-field label { font-size: 11px; font-weight: 600; color: var(--cn-text-secondary); }
.bulk-field input, .bulk-field select { padding: 8px 12px; border: 1px solid var(--cn-border); border-radius: var(--radius-sm); font-size: 12px; font-family: inherit; background: var(--cn-surface); }
.bulk-field input:focus, .bulk-field select:focus { outline: none; border-color: var(--cn-entity); }
.bulk-preview-btn { padding: 8px 16px; background: var(--cn-entity-bg); color: var(--cn-entity); border: 1px solid var(--cn-entity-border); border-radius: var(--radius-sm); font-size: 12px; font-weight: 700; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.bulk-preview-btn:hover { background: var(--cn-entity); color: white; }
.bulk-preview { margin-top: 0; }
.bulk-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.bulk-table th { text-align: left; padding: 8px 12px; font-size: 10px; font-weight: 700; color: var(--cn-text-muted); text-transform: uppercase; letter-spacing: 0.5px; background: var(--cn-bg); border-bottom: 1px solid var(--cn-border); }
.bulk-table td { padding: 8px 12px; border-bottom: 1px solid var(--cn-border-light); color: var(--cn-text-secondary); }
.bulk-table tr:hover td { background: var(--cn-entity-bg); }
.bulk-more { font-size: 11px; color: var(--cn-text-muted); text-align: center; padding: 8px; font-style: italic; }

/* ============================================
   ENTITY WIZARD MODAL
   ============================================ */
.wizard-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(4px); z-index: 3000; justify-content: center; align-items: center; }
.wizard-overlay.active { display: flex; }
.wizard-modal { background: var(--cn-surface); border-radius: var(--radius-xl); width: 600px; max-width: 94vw; max-height: 90vh; display: flex; flex-direction: column; box-shadow: var(--shadow-xl); animation: wizardIn 0.3s ease; }
@keyframes wizardIn { from { opacity: 0; transform: translateY(20px) scale(0.97); } to { opacity: 1; transform: translateY(0) scale(1); } }
.wizard-header { padding: 24px 28px 0; display: flex; align-items: center; justify-content: space-between; }
.wizard-header h2 { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
.wizard-close { width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--cn-border); background: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--cn-text-secondary); transition: all 0.2s; font-family: inherit; }
.wizard-close:hover { background: var(--cn-bg); }

/* Steps indicator */
.wizard-steps { display: flex; gap: 4px; padding: 16px 28px 0; }
.wiz-step { flex: 1; height: 4px; border-radius: 3px; background: var(--cn-border); transition: background 0.3s; }
.wiz-step.active { background: var(--cn-entity); }
.wiz-step.done { background: var(--cn-good); }

.wizard-body { flex: 1; overflow-y: auto; padding: 24px 28px; }
.wizard-footer { padding: 16px 28px; border-top: 1px solid var(--cn-border); display: flex; justify-content: space-between; align-items: center; }
.wiz-btn { padding: 10px 22px; border-radius: var(--radius-md); font-size: 13px; font-weight: 700; cursor: pointer; font-family: inherit; transition: all 0.2s; border: none; }
.wiz-btn.secondary { background: var(--cn-bg); color: var(--cn-text-secondary); border: 1px solid var(--cn-border); }
.wiz-btn.secondary:hover { background: var(--cn-border-light); }
.wiz-btn.primary { background: linear-gradient(135deg, var(--cn-entity), #047857); color: white; }
.wiz-btn.primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
.wiz-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
.step-label { font-size: 12px; font-weight: 600; color: var(--cn-text-muted); }

/* Step 1: Type picker */
.type-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
.type-option { padding: 16px 8px; border: 2px solid var(--cn-border); border-radius: var(--radius-md); text-align: center; cursor: pointer; transition: all 0.2s; }
.type-option:hover { border-color: var(--cn-entity-border); background: var(--cn-entity-bg); }
.type-option.selected { border-color: var(--cn-entity); background: var(--cn-entity-bg); }
.type-option .type-icon { font-size: 28px; display: block; margin-bottom: 6px; }
.type-option .type-name { font-size: 11px; font-weight: 700; color: var(--cn-text); }

/* Step 2: Parent picker */
.parent-tree { max-height: 300px; overflow-y: auto; border: 1px solid var(--cn-border); border-radius: var(--radius-md); padding: 8px; }
.parent-option { display: flex; align-items: center; gap: 6px; padding: 8px 10px; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; font-size: 12px; }
.parent-option:hover { background: var(--cn-bg); }
.parent-option.selected { background: var(--cn-entity-bg); }
.parent-option .par-indent { display: inline-block; }
.parent-option .par-icon { font-size: 14px; }
.parent-option .par-name { font-weight: 600; }

/* Step 3: Details form */
.wiz-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.wiz-form-group { display: flex; flex-direction: column; gap: 5px; }
.wiz-form-group.full { grid-column: 1 / -1; }
.wiz-form-group label { font-size: 12px; font-weight: 600; color: var(--cn-text-secondary); }
.wiz-form-group label .req { color: var(--cn-poor); }
.wiz-form-group input, .wiz-form-group select, .wiz-form-group textarea { padding: 9px 12px; border: 1px solid var(--cn-border); border-radius: var(--radius-sm); font-size: 13px; font-family: inherit; background: var(--cn-surface); color: var(--cn-text); }
.wiz-form-group input:focus, .wiz-form-group select:focus { outline: none; border-color: var(--cn-entity); box-shadow: 0 0 0 3px rgba(5,150,105,0.08); }
.wiz-form-group textarea { resize: vertical; min-height: 60px; }

/* Step 4: Summary */
.summary-card { background: var(--cn-bg); border-radius: var(--radius-md); padding: 20px; }
.summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--cn-border-light); font-size: 13px; }
.summary-row:last-child { border-bottom: none; }
.summary-row .s-label { color: var(--cn-text-muted); font-weight: 500; }
.summary-row .s-value { color: var(--cn-text); font-weight: 700; }
.summary-icon-row { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
.summary-icon-row .big-icon { font-size: 36px; }
.summary-icon-row .summary-title { font-size: 18px; font-weight: 800; }
.summary-icon-row .summary-type { font-size: 12px; color: var(--cn-entity); font-weight: 700; }

/* ============================================
   ANIMATIONS
   ============================================ */
@keyframes fadeInUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 900px) {
  .left-panel { width: 280px; min-width: 280px; }
  .detail-grid { grid-template-columns: 1fr; }
}
@media (max-width: 640px) {
  .left-panel { display: none; }
  .right-scroll { padding: 16px; }
  .type-grid { grid-template-columns: repeat(3, 1fr); }
}
</style>
</head>
<body>

<div class="phase-badge">P2 — Entity</div>
<button class="journey-map-btn" onclick="toggleJourney()">&#x1F5FA;&#xFE0F; Journey Map</button>

<!-- ============================================
     JOURNEY MAP OVERLAY
     ============================================ -->
<div class="journey-overlay" id="journeyOverlay" onclick="toggleJourney()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:2000;justify-content:center;align-items:center">
  <div style="background:white;border-radius:20px;padding:32px;max-width:720px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.15)" onclick="event.stopPropagation()">
    <h3 style="font-size:18px;font-weight:700;margin-bottom:20px">UX Journey Map</h3>
    <div style="display:flex;flex-wrap:wrap;gap:12px">
      <a href="01-nomenclature-picker.html" style="flex:1;min-width:160px;padding:14px;border-radius:10px;border:2px solid #e2e8f0;font-size:13px;text-decoration:none;color:#0f172a;transition:all 0.2s"><div style="font-size:11px;font-weight:700;color:#1e3a5f;margin-bottom:4px">P0</div><div style="font-weight:600">Nomenclature Picker</div></a>
      <a href="02-equipment-registry.html" style="flex:1;min-width:160px;padding:14px;border-radius:10px;border:2px solid #e2e8f0;font-size:13px;text-decoration:none;color:#0f172a;transition:all 0.2s"><div style="font-size:11px;font-weight:700;color:#d97706;margin-bottom:4px">P1</div><div style="font-weight:600">Equipment Registry</div></a>
      <a href="03-entity-registry.html" style="flex:1;min-width:160px;padding:14px;border-radius:10px;border:2px solid #059669;background:#ecfdf5;font-size:13px;text-decoration:none;color:#0f172a"><div style="font-size:11px;font-weight:700;color:#059669;margin-bottom:4px">P2 — CURRENT</div><div style="font-weight:600">Entity Registry</div></a>
      <a href="04-contract-wizard-enhanced.html" style="flex:1;min-width:160px;padding:14px;border-radius:10px;border:2px solid #e2e8f0;font-size:13px;text-decoration:none;color:#0f172a;transition:all 0.2s"><div style="font-size:11px;font-weight:700;color:#1e3a5f;margin-bottom:4px">P1+P2</div><div style="font-weight:600">Contract Wizard</div></a>
      <a href="05-contract-dashboard.html" style="flex:1;min-width:160px;padding:14px;border-radius:10px;border:2px solid #e2e8f0;font-size:13px;text-decoration:none;color:#0f172a;transition:all 0.2s"><div style="font-size:11px;font-weight:700;color:#1e3a5f;margin-bottom:4px">P0+P3</div><div style="font-weight:600">Contract Dashboard</div></a>
      <a href="06-buyer-experience.html" style="flex:1;min-width:160px;padding:14px;border-radius:10px;border:2px solid #e2e8f0;font-size:13px;text-decoration:none;color:#0f172a;transition:all 0.2s"><div style="font-size:11px;font-weight:700;color:#1e3a5f;margin-bottom:4px">P2+P4</div><div style="font-weight:600">Buyer Experience</div></a>
    </div>
  </div>
</div>

<!-- ============================================
     APP SHELL
     ============================================ -->
<div class="app-shell">

  <!-- LEFT PANEL: Hierarchy Tree -->
  <div class="left-panel">
    <div class="left-header">
      <div class="campus-label">Property Hierarchy</div>
      <div class="campus-name">Apollo Hospitals</div>
      <div class="campus-sub">Jubilee Hills Campus, Hyderabad</div>
    </div>
    <div class="left-actions">
      <button class="add-entity-btn" onclick="openWizard()">+ Add Entity</button>
      <input class="tree-search" type="text" placeholder="Search entities..." oninput="filterTree(this.value)">
    </div>
    <div class="tree-container" id="treeContainer"></div>
  </div>

  <!-- RIGHT PANEL: Detail -->
  <div class="right-panel">
    <div class="right-scroll" id="rightPanel">
      <!-- populated by JS -->
    </div>
  </div>

</div>

<!-- ============================================
     ENTITY CREATION WIZARD
     ============================================ -->
<div class="wizard-overlay" id="wizardOverlay">
  <div class="wizard-modal" onclick="event.stopPropagation()">
    <div class="wizard-header">
      <h2>&#x1F3D7;&#xFE0F; Add New Entity</h2>
      <button class="wizard-close" onclick="closeWizard()">&times;</button>
    </div>
    <div class="wizard-steps" id="wizSteps">
      <div class="wiz-step active"></div>
      <div class="wiz-step"></div>
      <div class="wiz-step"></div>
      <div class="wiz-step"></div>
    </div>
    <div class="wizard-body" id="wizBody"></div>
    <div class="wizard-footer">
      <span class="step-label" id="wizStepLabel">Step 1 of 4</span>
      <div style="display:flex;gap:8px">
        <button class="wiz-btn secondary" id="wizBack" onclick="wizPrev()">Back</button>
        <button class="wiz-btn primary" id="wizNext" onclick="wizNext()">Next</button>
      </div>
    </div>
  </div>
</div>


<script>
/* ============================================
   DATA: Entity Hierarchy
   ============================================ */
const entityData = {
  id: 'campus',
  name: 'Apollo Hospitals — Jubilee Hills Campus',
  type: 'campus',
  icon: '\u{1F3DB}\uFE0F',
  condition: 'good',
  score: 8.8,
  area: '4.5 acres',
  expanded: true,
  children: [
    {
      id: 'bldg-a',
      name: 'Building A — Main Hospital',
      type: 'building',
      icon: '\u{1F3E2}',
      condition: 'good',
      score: 8.5,
      area: '45,000 sqft',
      expanded: true,
      children: [
        {
          id: 'bldg-a-gf',
          name: 'Ground Floor',
          type: 'floor',
          icon: '\u{1F4CA}',
          condition: 'good',
          score: 8.7,
          area: '8,000 sqft',
          floorNum: 0,
          expanded: false,
          children: [
            { id: 'gf-er', name: 'Emergency Ward', type: 'room', icon: '\u{1F6AA}', condition: 'good', score: 9.0 },
            { id: 'gf-pharmacy', name: 'Pharmacy', type: 'room', icon: '\u{1F6AA}', condition: 'good', score: 8.5 },
            { id: 'gf-reception', name: 'Reception', type: 'room', icon: '\u{1F6AA}', condition: 'good', score: 8.8 }
          ]
        },
        {
          id: 'bldg-a-f1',
          name: 'Floor 1 — OPD',
          type: 'floor',
          icon: '\u{1F4CA}',
          condition: 'good',
          score: 8.3,
          area: '7,000 sqft',
          floorNum: 1,
          expanded: false,
          children: [
            { id: 'f1-consult1', name: 'Consultation Room 1', type: 'room', icon: '\u{1F6AA}', condition: 'good', score: 8.4 },
            { id: 'f1-consult2', name: 'Consultation Room 2', type: 'room', icon: '\u{1F6AA}', condition: 'fair', score: 7.1 },
            { id: 'f1-waiting', name: 'Waiting Area', type: 'room', icon: '\u{1F6AA}', condition: 'good', score: 8.5 }
          ]
        },
        {
          id: 'bldg-a-f2',
          name: 'Floor 2 — Radiology',
          type: 'floor',
          icon: '\u{1F4CA}',
          condition: 'good',
          score: 8.5,
          area: '6,500 sqft',
          floorNum: 2,
          expanded: true,
          children: [
            { id: 'f2-mri', name: 'MRI Room', type: 'room', icon: '\u{1F6AA}', condition: 'good', score: 9.2 },
            { id: 'f2-ct', name: 'CT Room', type: 'room', icon: '\u{1F6AA}', condition: 'good', score: 8.6 },
            { id: 'f2-xray', name: 'X-Ray Room', type: 'room', icon: '\u{1F6AA}', condition: 'fair', score: 7.4 }
          ]
        },
        {
          id: 'bldg-a-f3',
          name: 'Floor 3 — Surgical',
          type: 'floor',
          icon: '\u{1F4CA}',
          condition: 'good',
          score: 9.1,
          area: '7,500 sqft',
          floorNum: 3,
          expanded: false,
          children: []
        },
        {
          id: 'bldg-a-f4',
          name: 'Floor 4 — ICU',
          type: 'floor',
          icon: '\u{1F4CA}',
          condition: 'fair',
          score: 7.6,
          area: '6,000 sqft',
          floorNum: 4,
          expanded: false,
          children: []
        }
      ]
    },
    {
      id: 'bldg-b',
      name: 'Building B — Wellness Center',
      type: 'building',
      icon: '\u{1F3E2}',
      condition: 'good',
      score: 8.1,
      area: '12,000 sqft',
      expanded: false,
      children: [
        {
          id: 'bldg-b-gf',
          name: 'Ground Floor',
          type: 'floor',
          icon: '\u{1F4CA}',
          condition: 'good',
          score: 8.2,
          area: '6,000 sqft',
          floorNum: 0,
          expanded: false,
          children: []
        },
        {
          id: 'bldg-b-f1',
          name: 'Floor 1',
          type: 'floor',
          icon: '\u{1F4CA}',
          condition: 'fair',
          score: 7.5,
          area: '6,000 sqft',
          floorNum: 1,
          expanded: false,
          children: []
        }
      ]
    },
    {
      id: 'garden',
      name: 'Garden & Landscaping',
      type: 'garden',
      icon: '\u{1F33F}',
      condition: 'good',
      score: 8.9,
      area: '2 acres',
      expanded: false,
      children: []
    },
    {
      id: 'parking',
      name: 'Parking — Basement',
      type: 'parking',
      icon: '\u{1F17F}\uFE0F',
      condition: 'fair',
      score: 7.2,
      area: '200 cars',
      expanded: false,
      children: []
    },
    {
      id: 'pool',
      name: 'Swimming Pool',
      type: 'pool',
      icon: '\u{1F3CA}',
      condition: 'good',
      score: 8.4,
      area: '1,200 sqft',
      expanded: false,
      children: []
    }
  ]
};

/* Additional detail data for entities */
const entityDetails = {
  'bldg-a-f2': {
    code: 'BLD-A-F2',
    zone: 'Radiology',
    parent: 'Building A — Main Hospital',
    contract: { id: 'CON-10055', type: 'FMC', status: 'Active', until: 'Dec 2026' },
    rooms: 3,
    inspections: [
      { date: '15 Jan 2026', desc: 'Quarterly inspection — all equipment verified', score: 8.5, cond: 'good' },
      { date: '10 Oct 2025', desc: 'Post-monsoon assessment — minor water ingress noted', score: 7.8, cond: 'fair' },
      { date: '05 Jul 2025', desc: 'Mid-year review — HVAC filter replacement', score: 8.2, cond: 'good' },
      { date: '12 Apr 2025', desc: 'Annual comprehensive audit — passed all checks', score: 8.9, cond: 'good' }
    ]
  },
  'campus': {
    code: 'APJH-CAMPUS',
    zone: 'Full Campus',
    parent: '—',
    contract: { id: 'CON-10050', type: 'FMC', status: 'Active', until: 'Mar 2027' },
    rooms: null,
    inspections: [
      { date: '20 Jan 2026', desc: 'Campus-wide annual safety audit', score: 8.8, cond: 'good' },
      { date: '15 Aug 2025', desc: 'Exterior structural review', score: 8.5, cond: 'good' }
    ]
  },
  'bldg-a': {
    code: 'BLD-A',
    zone: 'Main Hospital',
    parent: 'Campus',
    contract: { id: 'CON-10055', type: 'FMC', status: 'Active', until: 'Dec 2026' },
    rooms: null,
    inspections: [
      { date: '18 Jan 2026', desc: 'Building-wide systems check', score: 8.5, cond: 'good' },
      { date: '22 Sep 2025', desc: 'Fire safety compliance audit', score: 8.8, cond: 'good' },
      { date: '14 Jun 2025', desc: 'Elevator maintenance inspection', score: 8.0, cond: 'good' }
    ]
  }
};

/* Default detail for any node without specific data */
function getDetail(node) {
  if (entityDetails[node.id]) return entityDetails[node.id];
  // Generate generic detail
  const parent = findParent(entityData, node.id);
  return {
    code: node.id.toUpperCase().replace(/-/g, '-'),
    zone: node.name.replace(/Floor \d+ — /, '').replace(/Ground Floor/, 'General'),
    parent: parent ? parent.name : '—',
    contract: { id: 'CON-10055', type: 'FMC', status: 'Active', until: 'Dec 2026' },
    rooms: node.children ? node.children.length : null,
    inspections: [
      { date: '15 Jan 2026', desc: 'Regular quarterly inspection', score: node.score, cond: node.condition },
      { date: '10 Oct 2025', desc: 'Previous quarter inspection', score: Math.max(6.5, node.score - 0.5), cond: node.score - 0.5 >= 7.5 ? 'good' : 'fair' }
    ]
  };
}

function findParent(tree, targetId, parent) {
  if (tree.id === targetId) return parent || null;
  if (tree.children) {
    for (const c of tree.children) {
      const result = findParent(c, targetId, tree);
      if (result) return result;
    }
  }
  return null;
}

function findNode(tree, targetId) {
  if (tree.id === targetId) return tree;
  if (tree.children) {
    for (const c of tree.children) {
      const result = findNode(c, targetId);
      if (result) return result;
    }
  }
  return null;
}

/* ============================================
   STATE
   ============================================ */
let selectedId = 'bldg-a-f2';
let searchFilter = '';

/* ============================================
   TREE RENDERING
   ============================================ */
function renderTree() {
  const container = document.getElementById('treeContainer');
  container.innerHTML = renderNode(entityData, 0);
}

function renderNode(node, depth) {
  const hasChildren = node.children && node.children.length > 0;
  const isSelected = node.id === selectedId;
  const matchesSearch = searchFilter === '' || node.name.toLowerCase().includes(searchFilter.toLowerCase());
  const childMatches = hasChildren && nodeTreeMatches(node, searchFilter);

  if (searchFilter && !matchesSearch && !childMatches) return '';

  const arrowClass = hasChildren ? (node.expanded ? 'tree-arrow expanded' : 'tree-arrow') : 'tree-arrow empty';
  const condClass = node.condition || 'good';

  let html = `<div class="tree-node indent-${Math.min(depth, 3)}" data-id="${node.id}">`;
  html += `<div class="tree-row${isSelected ? ' selected' : ''}" onclick="selectNode('${node.id}')" data-nodeid="${node.id}">`;
  html += `<span class="${arrowClass}" onclick="event.stopPropagation(); toggleExpand('${node.id}')">\u25B6</span>`;
  html += `<span class="tree-icon">${node.icon}</span>`;
  html += `<span class="tree-name">${node.name}</span>`;
  if (node.area) html += `<span class="tree-badge">${node.area}</span>`;
  html += `<span class="tree-condition ${condClass}"></span>`;
  html += `</div>`;

  if (hasChildren) {
    const childrenVisible = node.expanded || (searchFilter && childMatches);
    html += `<div class="tree-children${childrenVisible ? '' : ' collapsed'}" style="max-height:${childrenVisible ? '2000px' : '0'}">`;
    for (const child of node.children) {
      html += renderNode(child, depth + 1);
    }
    html += `</div>`;
  }

  html += `</div>`;
  return html;
}

function nodeTreeMatches(node, filter) {
  if (!filter) return true;
  if (node.name.toLowerCase().includes(filter.toLowerCase())) return true;
  if (node.children) {
    for (const c of node.children) {
      if (nodeTreeMatches(c, filter)) return true;
    }
  }
  return false;
}

function toggleExpand(id) {
  const node = findNode(entityData, id);
  if (node) {
    node.expanded = !node.expanded;
    renderTree();
  }
}

function selectNode(id) {
  selectedId = id;
  renderTree();
  renderDetail();
}

function filterTree(val) {
  searchFilter = val;
  renderTree();
}

/* ============================================
   RIGHT PANEL — Detail Rendering
   ============================================ */
function renderDetail() {
  const panel = document.getElementById('rightPanel');
  const node = findNode(entityData, selectedId);
  if (!node) { panel.innerHTML = '<p style="color:var(--cn-text-muted);padding:40px;text-align:center">Select an entity from the hierarchy tree</p>'; return; }

  const detail = getDetail(node);
  const circumference = 2 * Math.PI * 28;
  const offset = circumference - (node.score / 10) * circumference;
  const ringColor = node.score >= 8 ? 'var(--cn-good)' : (node.score >= 6.5 ? 'var(--cn-fair)' : 'var(--cn-poor)');

  // Breadcrumb path
  const path = buildPath(entityData, selectedId);
  const breadcrumb = path.map(p => p.name.split(' — ')[0]).join(' > ');

  let html = '';

  // Header
  html += `<div class="entity-header">`;
  html += `<div class="condition-ring">
    <svg viewBox="0 0 64 64"><circle class="ring-bg" cx="32" cy="32" r="28"/><circle class="ring-fg" cx="32" cy="32" r="28" stroke="${ringColor}" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/></svg>
    <div class="ring-score">${node.score}<span class="ring-label">/ 10</span></div>
  </div>`;
  html += `<div class="entity-info">
    <div class="entity-title-row">
      <h1>${node.name}</h1>
      <span class="type-badge">${node.icon} ${capitalize(node.type)}</span>
    </div>
    <div class="breadcrumb-path">${breadcrumb}</div>
  </div>`;
  html += `</div>`;

  // Details + Dimensions cards
  html += `<div class="detail-grid">`;

  // Details card
  html += `<div class="detail-card"><h3><span class="card-icon">\u{1F4CB}</span> Details</h3>`;
  html += `<div class="detail-kv-grid">`;
  html += kvRow('Type', capitalize(node.type));
  html += kvRow('Parent', detail.parent);
  html += kvRow('Code', detail.code);
  html += kvRow('Zone', detail.zone);
  if (node.type === 'floor' && node.floorNum !== undefined) html += kvRow('Floor Number', node.floorNum === 0 ? 'Ground' : node.floorNum);
  html += `</div></div>`;

  // Dimensions card
  html += `<div class="detail-card"><h3><span class="card-icon">\u{1F4D0}</span> Dimensions</h3>`;
  html += `<div class="detail-kv-grid">`;
  if (node.area) html += kvRow('Area', node.area);
  if (detail.rooms !== null && detail.rooms !== undefined) html += kvRow('Rooms', detail.rooms);
  if (node.type === 'building') {
    const floors = node.children ? node.children.length : 0;
    html += kvRow('Floors', floors);
  }
  if (node.type === 'campus') html += kvRow('Buildings', entityData.children.filter(c => c.type === 'building').length);
  html += `</div></div>`;
  html += `</div>`;

  // Contract coverage
  if (detail.contract) {
    html += `<div class="contract-coverage"><h3>\u{1F4C4} Contract Coverage</h3>`;
    html += `<div class="coverage-row">`;
    html += `<span class="coverage-dot"></span>`;
    html += `<div class="coverage-info">
      <div class="cov-title">Under ${detail.contract.type} Contract #${detail.contract.id}</div>
      <div class="cov-sub">Active until ${detail.contract.until}</div>
    </div>`;
    html += `<span class="coverage-badge">${detail.contract.status}</span>`;
    html += `</div></div>`;
  }

  // Inspection history
  if (detail.inspections && detail.inspections.length) {
    html += `<div class="inspection-card"><h3><span class="card-icon">\u{1F50D}</span> Inspection History</h3>`;
    html += `<div class="timeline">`;
    detail.inspections.forEach(insp => {
      const sc = insp.cond || (insp.score >= 8 ? 'good' : (insp.score >= 6.5 ? 'fair' : 'poor'));
      html += `<div class="timeline-item">
        <div class="timeline-dot ${sc}"></div>
        <div class="timeline-date">${insp.date}</div>
        <div class="timeline-desc">${insp.desc} <span class="timeline-score ${sc}">${insp.score}/10</span></div>
      </div>`;
    });
    html += `</div></div>`;
  }

  // Schematic Property Map — show for building-level entity or its children
  const building = findBuildingAncestor(entityData, selectedId);
  if (building && building.children && building.children.length > 0) {
    html += renderSchematic(building);
  }

  // Bulk creation card
  html += renderBulkCard();

  panel.innerHTML = html;
  panel.scrollTop = 0;

  // Trigger animations
  initBulkPreview();
}

function kvRow(label, value) {
  return `<div class="detail-kv"><span class="kv-label">${label}</span><span class="kv-value">${value}</span></div>`;
}

function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

function buildPath(tree, targetId, path) {
  path = path || [];
  if (tree.id === targetId) { path.push(tree); return path; }
  if (tree.children) {
    for (const c of tree.children) {
      const result = buildPath(c, targetId, [...path, tree]);
      if (result) return result;
    }
  }
  return null;
}

function findBuildingAncestor(tree, targetId) {
  // If selected node IS a building, return it
  const node = findNode(tree, targetId);
  if (node && node.type === 'building') return node;
  // Walk up
  const path = buildPath(tree, targetId);
  if (!path) return null;
  for (let i = path.length - 1; i >= 0; i--) {
    if (path[i].type === 'building') return path[i];
  }
  return null;
}

/* ============================================
   SCHEMATIC PROPERTY MAP
   ============================================ */
function renderSchematic(building) {
  let html = `<div class="schematic-section"><h3><span class="card-icon">\u{1F3D7}\uFE0F</span> Schematic Property Map — ${building.name.split(' — ')[0]}</h3>`;
  html += `<div class="schematic-label">${building.name}</div>`;
  html += `<div class="building-stack">`;

  const floors = building.children || [];
  floors.forEach(floor => {
    const isSelected = floor.id === selectedId;
    const floorCond = floor.condition === 'good' ? 'good-floor' : (floor.condition === 'fair' ? 'fair-floor' : 'poor-floor');
    html += `<div class="floor-bar ${floorCond}${isSelected ? ' selected-entity' : ''}" onclick="selectNode('${floor.id}')">`;
    html += `<div class="floor-label">${floor.name.replace(/ — .*/, '').replace('Ground Floor', 'GF')}</div>`;
    html += `<div class="floor-rooms">`;

    if (floor.children && floor.children.length > 0) {
      floor.children.forEach(room => {
        const roomCond = room.condition === 'good' ? 'good-tint' : (room.condition === 'fair' ? 'fair-tint' : 'poor-tint');
        const isRoomSelected = room.id === selectedId;
        html += `<div class="room-block ${roomCond}${isRoomSelected ? ' selected-room' : ''}" onclick="event.stopPropagation(); selectNode('${room.id}')">
          ${room.name.replace('Consultation ', 'Consult ').replace(' Room', '')}
          <div class="room-tooltip">${room.name} — ${room.score}/10</div>
        </div>`;
      });
    } else {
      html += `<div class="room-block good-tint" style="flex:1;cursor:default;opacity:0.5">No rooms registered</div>`;
    }

    html += `</div></div>`;
  });

  html += `</div>`;

  // Legend
  html += `<div class="schematic-legend">
    <div class="legend-item"><div class="legend-swatch" style="background:#d1fae5"></div> Good (8+)</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#fef3c7"></div> Fair (6.5-8)</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#fee2e2"></div> Poor (&lt;6.5)</div>
    <div class="legend-item"><div class="legend-swatch" style="background:var(--cn-primary);opacity:0.6"></div> Selected</div>
  </div>`;

  html += `</div>`;
  return html;
}

/* ============================================
   BULK CREATION CARD
   ============================================ */
function renderBulkCard() {
  return `
  <div class="bulk-card">
    <h3>\u{26A1} Bulk Create Entities</h3>
    <div class="bulk-sub">"I have 120 flats in Building B" — quickly generate entity entries using a naming pattern.</div>
    <div class="bulk-input-row">
      <div class="bulk-field">
        <label>Entity Type</label>
        <select id="bulkType">
          <option value="Room">Room</option>
          <option value="Flat">Flat</option>
          <option value="Ward">Ward</option>
          <option value="Office">Office</option>
        </select>
      </div>
      <div class="bulk-field">
        <label>Parent</label>
        <select id="bulkParent">
          <option>Building B — Wellness Center</option>
          <option>Building A — Main Hospital</option>
        </select>
      </div>
      <div class="bulk-field">
        <label>Count</label>
        <input type="number" id="bulkCount" value="120" min="1" max="500" style="width:80px">
      </div>
      <div class="bulk-field">
        <label>Naming Pattern</label>
        <input type="text" id="bulkPattern" value="Flat {floor}{unit}" style="width:160px" placeholder="e.g. Flat {floor}{unit}">
      </div>
      <button class="bulk-preview-btn" onclick="generateBulkPreview()">Preview</button>
    </div>
    <div class="bulk-preview" id="bulkPreview"></div>
  </div>`;
}

function initBulkPreview() {
  // Auto-generate preview on load
  setTimeout(() => generateBulkPreview(), 100);
}

function generateBulkPreview() {
  const el = document.getElementById('bulkPreview');
  if (!el) return;
  const count = parseInt(document.getElementById('bulkCount').value) || 10;
  const pattern = document.getElementById('bulkPattern').value || 'Flat {floor}{unit}';
  const type = document.getElementById('bulkType').value;

  const samples = [];
  for (let i = 0; i < Math.min(count, 5); i++) {
    const floor = Math.floor(i / 10) + 1;
    const unit = String((i % 10) + 1).padStart(2, '0');
    const name = pattern.replace('{floor}', floor).replace('{unit}', unit);
    samples.push({ name, code: `BLD-B-${type.toUpperCase().substring(0,2)}-${floor}${unit}`, floor: `Floor ${floor}`, area: '650 sqft' });
  }

  let html = `<table class="bulk-table">
    <thead><tr><th>#</th><th>Name</th><th>Code</th><th>Parent Floor</th><th>Area</th></tr></thead>
    <tbody>`;
  samples.forEach((s, i) => {
    html += `<tr><td>${i + 1}</td><td>${s.name}</td><td>${s.code}</td><td>${s.floor}</td><td>${s.area}</td></tr>`;
  });
  html += `</tbody></table>`;
  if (count > 5) {
    html += `<div class="bulk-more">...and ${count - 5} more entities will be created</div>`;
  }
  el.innerHTML = html;
}

/* ============================================
   ENTITY CREATION WIZARD
   ============================================ */
let wizStep = 1;
const wizData = { type: '', parent: '', name: '', code: '', area: '', length: '', width: '', zone: '', specs: '' };

const entityTypes = [
  { key: 'building', icon: '\u{1F3E2}', name: 'Building' },
  { key: 'floor', icon: '\u{1F4CA}', name: 'Floor' },
  { key: 'room', icon: '\u{1F6AA}', name: 'Room' },
  { key: 'garden', icon: '\u{1F33F}', name: 'Garden' },
  { key: 'pool', icon: '\u{1F3CA}', name: 'Pool' },
  { key: 'cleanroom', icon: '\u{1F9EA}', name: 'Clean Room' },
  { key: 'parking', icon: '\u{1F17F}\uFE0F', name: 'Parking' },
  { key: 'common', icon: '\u{1F6CB}\uFE0F', name: 'Common Area' },
  { key: 'terrace', icon: '\u{2600}\uFE0F', name: 'Terrace' },
  { key: 'warehouse', icon: '\u{1F4E6}', name: 'Warehouse' }
];

function openWizard() {
  wizStep = 1;
  wizData.type = '';
  wizData.parent = '';
  wizData.name = '';
  wizData.code = '';
  wizData.area = '';
  wizData.length = '';
  wizData.width = '';
  wizData.zone = '';
  wizData.specs = '';
  document.getElementById('wizardOverlay').classList.add('active');
  renderWizStep();
}

function closeWizard() {
  document.getElementById('wizardOverlay').classList.remove('active');
}

function wizNext() {
  if (wizStep === 1 && !wizData.type) return;
  if (wizStep === 2 && !wizData.parent) return;
  if (wizStep < 4) { wizStep++; renderWizStep(); }
  else { closeWizard(); /* In production, would save */ }
}

function wizPrev() {
  if (wizStep > 1) { wizStep--; renderWizStep(); }
}

function renderWizStep() {
  const body = document.getElementById('wizBody');
  const steps = document.querySelectorAll('#wizSteps .wiz-step');
  steps.forEach((s, i) => {
    s.className = 'wiz-step';
    if (i < wizStep - 1) s.classList.add('done');
    if (i === wizStep - 1) s.classList.add('active');
  });

  document.getElementById('wizStepLabel').textContent = `Step ${wizStep} of 4`;
  document.getElementById('wizBack').style.display = wizStep === 1 ? 'none' : '';
  document.getElementById('wizNext').textContent = wizStep === 4 ? 'Create Entity' : 'Next';

  if (wizStep === 1) renderWizStep1(body);
  else if (wizStep === 2) renderWizStep2(body);
  else if (wizStep === 3) renderWizStep3(body);
  else renderWizStep4(body);
}

function renderWizStep1(body) {
  let html = '<h3 style="font-size:14px;font-weight:700;margin-bottom:4px">Select Entity Type</h3>';
  html += '<p style="font-size:12px;color:var(--cn-text-secondary);margin-bottom:16px">What kind of property entity are you registering?</p>';
  html += '<div class="type-grid">';
  entityTypes.forEach(t => {
    html += `<div class="type-option${wizData.type === t.key ? ' selected' : ''}" onclick="selectWizType('${t.key}')">
      <span class="type-icon">${t.icon}</span>
      <span class="type-name">${t.name}</span>
    </div>`;
  });
  html += '</div>';
  body.innerHTML = html;
}

function selectWizType(key) {
  wizData.type = key;
  renderWizStep();
}

function renderWizStep2(body) {
  let html = '<h3 style="font-size:14px;font-weight:700;margin-bottom:4px">Place in Hierarchy</h3>';
  html += '<p style="font-size:12px;color:var(--cn-text-secondary);margin-bottom:16px">Where does this entity belong in the property tree?</p>';
  html += '<div class="parent-tree">';
  html += renderParentOptions(entityData, 0);
  html += '</div>';
  body.innerHTML = html;
}

function renderParentOptions(node, depth) {
  let html = `<div class="parent-option${wizData.parent === node.id ? ' selected' : ''}" onclick="selectWizParent('${node.id}')" style="padding-left:${12 + depth * 20}px">
    <span class="par-icon">${node.icon}</span>
    <span class="par-name">${node.name}</span>
  </div>`;
  if (node.children) {
    node.children.forEach(c => { html += renderParentOptions(c, depth + 1); });
  }
  return html;
}

function selectWizParent(id) {
  wizData.parent = id;
  renderWizStep();
}

function renderWizStep3(body) {
  const selectedType = entityTypes.find(t => t.key === wizData.type);
  const typeName = selectedType ? selectedType.name : 'Entity';

  let html = '<h3 style="font-size:14px;font-weight:700;margin-bottom:4px">Fill Details</h3>';
  html += `<p style="font-size:12px;color:var(--cn-text-secondary);margin-bottom:16px">Provide information about the new ${typeName}.</p>`;
  html += `<div class="wiz-form-grid">
    <div class="wiz-form-group full">
      <label>Name <span class="req">*</span></label>
      <input type="text" id="wizName" placeholder="e.g. Floor 5 — Nephrology" value="${wizData.name}" onchange="wizData.name=this.value">
    </div>
    <div class="wiz-form-group">
      <label>Entity Code</label>
      <input type="text" id="wizCode" placeholder="e.g. BLD-A-F5" value="${wizData.code}" onchange="wizData.code=this.value">
    </div>
    <div class="wiz-form-group">
      <label>Zone / Department</label>
      <input type="text" id="wizZone" placeholder="e.g. Nephrology" value="${wizData.zone}" onchange="wizData.zone=this.value">
    </div>
    <div class="wiz-form-group">
      <label>Area (sqft)</label>
      <input type="text" id="wizArea" placeholder="e.g. 6500" value="${wizData.area}" onchange="wizData.area=this.value">
    </div>
    <div class="wiz-form-group">
      <label>Length (ft)</label>
      <input type="text" id="wizLength" placeholder="Optional" value="${wizData.length}" onchange="wizData.length=this.value">
    </div>
    <div class="wiz-form-group">
      <label>Width (ft)</label>
      <input type="text" id="wizWidth" placeholder="Optional" value="${wizData.width}" onchange="wizData.width=this.value">
    </div>
    <div class="wiz-form-group full">
      <label>Specifications / Notes</label>
      <textarea id="wizSpecs" placeholder="Any special requirements, equipment, or notes..." onchange="wizData.specs=this.value">${wizData.specs}</textarea>
    </div>
  </div>`;
  body.innerHTML = html;
}

function renderWizStep4(body) {
  // Capture latest values from step 3 inputs if they exist
  const nameEl = document.getElementById('wizName');
  if (nameEl) wizData.name = nameEl.value;
  const codeEl = document.getElementById('wizCode');
  if (codeEl) wizData.code = codeEl.value;
  const zoneEl = document.getElementById('wizZone');
  if (zoneEl) wizData.zone = zoneEl.value;
  const areaEl = document.getElementById('wizArea');
  if (areaEl) wizData.area = areaEl.value;
  const lengthEl = document.getElementById('wizLength');
  if (lengthEl) wizData.length = lengthEl.value;
  const widthEl = document.getElementById('wizWidth');
  if (widthEl) wizData.width = widthEl.value;
  const specsEl = document.getElementById('wizSpecs');
  if (specsEl) wizData.specs = specsEl.value;

  const selectedType = entityTypes.find(t => t.key === wizData.type);
  const parentNode = findNode(entityData, wizData.parent);

  let html = '<h3 style="font-size:14px;font-weight:700;margin-bottom:4px">Review & Create</h3>';
  html += '<p style="font-size:12px;color:var(--cn-text-secondary);margin-bottom:16px">Confirm the details below before creating.</p>';

  html += `<div class="summary-card">`;
  html += `<div class="summary-icon-row">
    <span class="big-icon">${selectedType ? selectedType.icon : '\u{1F3E2}'}</span>
    <div>
      <div class="summary-title">${wizData.name || 'Unnamed Entity'}</div>
      <div class="summary-type">${selectedType ? selectedType.name : 'Entity'}</div>
    </div>
  </div>`;
  html += summaryRow('Type', selectedType ? selectedType.name : '—');
  html += summaryRow('Parent', parentNode ? parentNode.name : '—');
  html += summaryRow('Code', wizData.code || 'Auto-generated');
  html += summaryRow('Zone', wizData.zone || '—');
  html += summaryRow('Area', wizData.area ? wizData.area + ' sqft' : '—');
  if (wizData.length) html += summaryRow('Length', wizData.length + ' ft');
  if (wizData.width) html += summaryRow('Width', wizData.width + ' ft');
  if (wizData.specs) html += summaryRow('Specifications', wizData.specs);
  html += `</div>`;

  body.innerHTML = html;
}

function summaryRow(label, value) {
  return `<div class="summary-row"><span class="s-label">${label}</span><span class="s-value">${value}</span></div>`;
}

/* ============================================
   JOURNEY MAP
   ============================================ */
function toggleJourney() {
  const o = document.getElementById('journeyOverlay');
  o.style.display = o.style.display === 'flex' ? 'none' : 'flex';
}

/* ============================================
   INIT
   ============================================ */
renderTree();
renderDetail();

// Close wizard on overlay click
document.getElementById('wizardOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeWizard();
});

</script>
</body>
</html>
