═══════════════════════════════════════════════════════════════════════════════
EDGE LAYER IMPROVEMENTS - CatalogStudio
═══════════════════════════════════════════════════════════════════════════════

Branch: edge-improvements
Date: January 2026
Author: Claude Code

═══════════════════════════════════════════════════════════════════════════════
FILES INCLUDED
═══════════════════════════════════════════════════════════════════════════════

1. contractnest-edge/supabase/migrations/catalog-studio/003_idempotency_keys.sql
   - Creates t_idempotency_keys table
   - RPC functions: check_idempotency, store_idempotency
   - Index and auto-cleanup trigger

2. contractnest-edge/supabase/functions/_shared/edgeUtils.ts
   - Shared utilities for all edge functions
   - HMAC signature validation
   - Pagination helpers
   - Idempotency check/store
   - Standard response helpers

3. contractnest-edge/supabase/functions/cat-blocks/index.ts
   - v2.0 with optimistic locking
   - Backward-compatible pagination
   - Idempotency for POST/PATCH
   - Replay protection

4. contractnest-edge/supabase/functions/cat-templates/index.ts
   - v2.0 with optimistic locking
   - Backward-compatible pagination
   - Idempotency for POST/PATCH/copy
   - Replay protection

═══════════════════════════════════════════════════════════════════════════════
IMPROVEMENTS IMPLEMENTED
═══════════════════════════════════════════════════════════════════════════════

1. OPTIMISTIC LOCKING
   - Version check on UPDATE operations
   - Returns 409 VERSION_CONFLICT if stale
   - Prevents lost updates in concurrent edits

2. BACKWARD-COMPATIBLE PAGINATION
   - If no page/limit params: returns old format (array)
   - If page/limit provided: returns { data, pagination }
   - Max 100 rows per request enforced

3. IDEMPOTENCY
   - x-idempotency-key header support
   - 24-hour key expiration
   - Returns cached response for duplicate requests

4. REPLAY PROTECTION
   - In-memory nonce cache
   - 5-minute cleanup interval
   - Prevents request replay attacks

5. SHARED UTILITIES
   - Common code in edgeUtils.ts
   - Consistent error responses
   - Standardized HMAC validation

═══════════════════════════════════════════════════════════════════════════════
COPY DESTINATIONS
═══════════════════════════════════════════════════════════════════════════════

FROM:
MANUAL_COPY_FILES/edge-improvements/contractnest-edge/

TO:
contractnest-edge/

Files map:
├── supabase/migrations/catalog-studio/003_idempotency_keys.sql
├── supabase/functions/_shared/edgeUtils.ts
├── supabase/functions/cat-blocks/index.ts
└── supabase/functions/cat-templates/index.ts

═══════════════════════════════════════════════════════════════════════════════
DEPLOYMENT ORDER
═══════════════════════════════════════════════════════════════════════════════

1. Run migration: 003_idempotency_keys.sql
2. Deploy _shared/edgeUtils.ts (shared module)
3. Deploy cat-blocks/index.ts
4. Deploy cat-templates/index.ts

═══════════════════════════════════════════════════════════════════════════════
BREAKING CHANGES: NONE
═══════════════════════════════════════════════════════════════════════════════

All changes are backward compatible:
- Pagination is optional (old behavior preserved if no params)
- Idempotency key is optional
- Existing API contracts unchanged

═══════════════════════════════════════════════════════════════════════════════
