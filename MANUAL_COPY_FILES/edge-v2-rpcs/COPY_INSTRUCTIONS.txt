â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ EDGE LAYER V2 RPCs + PERFORMANCE FIX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Branch: claude/init-submodules-dvcqd
Date: 2026-01-14

Files Changed:
  - contractnest-edge/supabase/functions/_shared/contacts/contactService.ts
    â†’ V2 RPCs with embedded relations and idempotency
  - contractnest-edge/supabase/functions/contacts/index.ts
    â†’ PERFORMANCE FIX: Non-blocking audit + removed from LIST ops

Submodules Affected: contractnest-edge

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ PERFORMANCE FIXES APPLIED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BEFORE (7-8 seconds for 20 records):
  âŒ 19 synchronous await auditLogger.log() calls
  âŒ Each audit = new Supabase client + DB INSERT + wait
  âŒ Audit logging on READ operations (LIST, GET, SEARCH)

AFTER (Expected: < 500ms):
  âœ… Audit logging removed from ALL read operations
  âœ… Write operations use fire-and-forget: .catch(() => {})
  âœ… Response returned IMMEDIATELY, audit logs async

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’» STEP-BY-STEP COMMANDS (Windows PowerShell)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Pull the Feature Branch
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cd "D:\projects\core projects\ContractNest\contractnest-combined"
git fetch origin
git checkout claude/init-submodules-dvcqd
git pull origin claude/init-submodules-dvcqd

STEP 2: Verify Files Received
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ls MANUAL_COPY_FILES\edge-v2-rpcs
type MANUAL_COPY_FILES\edge-v2-rpcs\COPY_INSTRUCTIONS.txt

STEP 3: Copy All Files (PowerShell)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Copy-Item "MANUAL_COPY_FILES\edge-v2-rpcs\contractnest-edge\supabase\functions\_shared\contacts\contactService.ts" -Destination "contractnest-edge\supabase\functions\_shared\contacts\contactService.ts" -Force

Copy-Item "MANUAL_COPY_FILES\edge-v2-rpcs\contractnest-edge\supabase\functions\contacts\index.ts" -Destination "contractnest-edge\supabase\functions\contacts\index.ts" -Force

Write-Host "âœ… All files copied!" -ForegroundColor Green

STEP 4: Commit Edge Changes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cd contractnest-edge
git status
git add .
git commit -m "perf: optimize Edge layer - non-blocking audit + v2 RPCs

PERFORMANCE FIX:
- Remove audit logging from READ operations (LIST, GET, SEARCH, STATS)
- Make WRITE audit logging fire-and-forget (non-blocking)
- Use v2 RPCs with embedded relations (no N+1 queries)

Expected improvement: 7-8s â†’ <500ms for list operations"
git push origin main
cd ..

STEP 5: Update Parent Repo Submodule References
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
git add contractnest-edge
git commit -m "chore: update contractnest-edge with performance optimizations"
git push origin claude/init-submodules-dvcqd

STEP 6: Merge to Master
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
git checkout master
git pull origin master
git merge claude/init-submodules-dvcqd

# If merge conflicts in submodules:
cd contractnest-edge
git checkout main
git pull origin main
cd ..
git add contractnest-edge

git commit -m "Merge claude/init-submodules-dvcqd - Edge performance fix"
git push origin master

STEP 7: Deploy Edge Function to Supabase
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cd contractnest-edge
supabase functions deploy contacts
cd ..

STEP 8: Verify Everything is Clean
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
git status
# Should show: "nothing to commit, working tree clean"

STEP 9: Test the Application
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cd contractnest-ui
npm run dev
# Hard refresh browser: Ctrl+F5

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§ª TESTING CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- [ ] List contacts - Should load in < 1 second (was 7-8s)
- [ ] Get contact by ID - Should load quickly
- [ ] Search contacts - Should be responsive
- [ ] Create contact - Should work (audit logs async)
- [ ] Update contact - Should work (audit logs async)
- [ ] Check Supabase logs for audit entries (they should still appear, just async)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ IF STILL SLOW - ADDITIONAL INVESTIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

If still slow after this fix, check:

1. API â†’ Edge network hop (biggest remaining bottleneck)
   - Consider: UI calling Edge directly for reads

2. Edge function cold starts
   - First request after idle = slow
   - Subsequent requests should be fast

3. Missing database indexes
   Run in Supabase SQL Editor:

   SELECT schemaname, tablename, indexname
   FROM pg_indexes
   WHERE tablename = 't_contacts';

   Ensure indexes exist on: tenant_id, is_live, status, created_at

4. RPC execution time
   Check Supabase Dashboard â†’ Database â†’ Query Performance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
