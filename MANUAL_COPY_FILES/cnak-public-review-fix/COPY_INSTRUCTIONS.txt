═══════════════════════════════════════════════════════════════════════════════
CNAK PUBLIC CONTRACT REVIEW FIX (v2 - with backward compatibility)
═══════════════════════════════════════════════════════════════════════════════

Branch: claude/init-submodules-acTX4
Date: 2026-02-05

PROBLEM SOLVED:
───────────────
When opening a contract review link from email (CNAK flow), the page redirects
to login instead of showing the public contract view.

ISSUES IDENTIFIED:
1. Missing endpoint definitions in serviceURLs.ts
2. Missing public endpoints in api.ts interceptor
3. URL mismatch: edge sends /contracts/review, route is /contract-review
4. Param mismatch: edge sends ?code=, page expects ?secret=

SOLUTION:
───────────────
1. Added PUBLIC_VALIDATE and PUBLIC_RESPOND endpoints to serviceURLs.ts
2. Added contract public endpoints to api.ts publicEndpoints array
3. Fixed review URL generation in edge function (for NEW emails)
4. Added backward compatibility:
   - Review page now accepts both 'secret' AND 'code' params
   - Added /contracts/review route alias (for OLD email links)

FILES MODIFIED:
───────────────
1. contractnest-ui/src/services/serviceURLs.ts
   → Added PUBLIC_VALIDATE: '/api/contracts/public/validate'
   → Added PUBLIC_RESPOND: '/api/contracts/public/respond'

2. contractnest-ui/src/services/api.ts
   → Added '/api/contracts/public/validate' to publicEndpoints array
   → Added '/api/contracts/public/respond' to publicEndpoints array

3. contractnest-ui/src/App.tsx
   → Added route: /contracts/review → ContractReviewPage (legacy alias)

4. contractnest-ui/src/pages/contracts/review/index.tsx
   → Now accepts both 'secret' and 'code' query params

5. contractnest-edge/supabase/functions/contracts/index.ts
   → Fixed URL from /contracts/review to /contract-review
   → Fixed param from code= to secret=

COPY COMMAND (PowerShell):
───────────────
cd "D:\projects\core projects\ContractNest\contractnest-combined"

Copy-Item "MANUAL_COPY_FILES\cnak-public-review-fix\contractnest-ui\*" -Destination "contractnest-ui\" -Recurse -Force
Copy-Item "MANUAL_COPY_FILES\cnak-public-review-fix\contractnest-edge\*" -Destination "contractnest-edge\" -Recurse -Force

Write-Host "All files copied!" -ForegroundColor Green

COPY COMMAND (Bash):
───────────────
cp -r MANUAL_COPY_FILES/cnak-public-review-fix/contractnest-ui/* contractnest-ui/
cp -r MANUAL_COPY_FILES/cnak-public-review-fix/contractnest-edge/* contractnest-edge/

DEPLOYMENT NOTES:
───────────────
1. UI changes require rebuild/redeploy of contractnest-ui
2. Edge function changes require: supabase functions deploy contracts

TESTING CHECKLIST:
───────────────
[ ] Test OLD email link format: /contracts/review?cnak=...&code=...
[ ] Test NEW link format: /contract-review?cnak=...&secret=...
[ ] Page loads WITHOUT redirecting to login
[ ] Contract details display correctly
[ ] Accept button works
[ ] Reject button works

TEST WITH YOUR EXISTING LINK:
───────────────
https://www.contractnest.com/contracts/review?cnak=CNAK-526FC7&code=376191761d6f43af8b78c250029c23c6

This should now work after copying files and rebuilding UI.

═══════════════════════════════════════════════════════════════════════════════
