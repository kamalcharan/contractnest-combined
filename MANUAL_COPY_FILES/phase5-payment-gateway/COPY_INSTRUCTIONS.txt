Phase 5: Payment Gateway - T1 + T2 + T3 + T4 + T5 + T6 + T7 + T8
===================================================================

Submodules Affected: contractnest-edge, contractnest-api, contractnest-ui

Files:
  contractnest-edge/supabase/migrations/contracts/011_payment_gateway_tables_rpc.sql
  contractnest-edge/supabase/functions/payment-gateway/index.ts
  contractnest-edge/supabase/functions/payment-gateway/providers/razorpay.ts
  contractnest-edge/supabase/functions/payment-webhook/index.ts
  contractnest-edge/supabase/functions/payment-webhook/providers/razorpay.ts

  contractnest-api/src/services/paymentGatewayService.ts      (NEW - T5)
  contractnest-api/src/controllers/paymentGatewayController.ts (NEW - T5)
  contractnest-api/src/routes/paymentGatewayRoutes.ts          (NEW - T5)
  contractnest-api/src/index.ts                                (MODIFIED - T5)

  contractnest-ui/src/hooks/queries/usePaymentGatewayQueries.ts    (NEW - T6)
  contractnest-ui/src/services/serviceURLs.ts                      (MODIFIED - T6)
  contractnest-ui/src/components/contracts/RecordPaymentDialog.tsx  (MODIFIED - T6)

  contractnest-ui/src/hooks/useRazorpayCheckout.ts                     (NEW - T7)

  contractnest-edge/supabase/migrations/jtd-framework/007_seed_payment_request_templates.sql (NEW - T8)

Contains:
  T1 - Tables:
    - t_contract_payment_requests (gateway-agnostic payment attempt tracking)
    - t_contract_payment_events (webhook events with idempotency)
    - Indexes, RLS policies, grants

  T2 - RPC Functions:
    - get_tenant_gateway_credentials(tenant_id, provider) — fetch encrypted credentials
    - create_payment_request(payload) — create payment request with auto attempt_number
    - verify_gateway_payment(payload) — verify + create receipt (terminal checkout)
    - process_payment_webhook(payload) — idempotent webhook processing (improved link matching)
    - get_payment_requests(payload) — list requests with events + summary

  T3 - Edge Function: payment-gateway
    - index.ts — CORS → HMAC → route to handler → provider → RPC
    - Routes: create-order, create-link, verify-payment, payment-status
    - providers/razorpay.ts — createOrder, createPaymentLink, fetchPayment, verifyPaymentSignature

  T4 - Edge Function: payment-webhook
    - index.ts — Public endpoint, no internal auth, provider signature verification
    - URL: /payment-webhook/{provider}/{tenant_id}
    - providers/razorpay.ts — verifyWebhookSignature, extractEventData, isPaymentEvent

  T5 - API: Express Payment Gateway Layer
    - paymentGatewayService.ts — HMAC-signed proxy to payment-gateway edge function
    - paymentGatewayController.ts — request validation, context extraction, error mapping
    - paymentGatewayRoutes.ts — 4 POST routes: create-order, create-link, verify-payment, status
    - index.ts — route loading (try/catch) + registration (app.use '/api/payments')

  T6 - UI: RecordPaymentDialog + Query Hooks
    - usePaymentGatewayQueries.ts — TanStack Query hooks: useCreateOrder, useCreateLink, useVerifyPayment
    - serviceURLs.ts — PAYMENTS endpoint section added
    - RecordPaymentDialog.tsx — online/offline toggle, collection mode selector
      - hasActiveGateway prop controls online option visibility
      - Collection modes: terminal (Pay Now), email_link, whatsapp_link
      - onOrderCreated callback for parent to launch Razorpay Checkout (T7)
      - Link success state with copy-to-clipboard

  T7 - UI: Razorpay Standard Checkout Hook
    - useRazorpayCheckout.ts — dynamic SDK script loading + checkout popup
    - openCheckout(orderData): opens Razorpay popup with gateway_key_id + gateway_order_id
    - Auto-verifies payment via useVerifyPayment on success
    - Handles dismiss/failure with toast notifications

  T8 - JTD: Payment Request Templates
    - Source type: payment_request (payment link sent to buyer)
    - Email template: payment_request_email with HTML card, green gradient, CTA button
    - WhatsApp template: payment_request_whatsapp (MSG91 provider_template_id: payment_request)
    - Variables: customer_name, tenant_name, invoice_number, amount, currency, payment_link, expire_hours
    - Tenant source configs for test tenants (auto_execute=true)

Copy Command (PowerShell):
  cd "D:\projects\core projects\ContractNest\contractnest-combined"
  Copy-Item "MANUAL_COPY_FILES\phase5-payment-gateway\contractnest-edge\*" -Destination "contractnest-edge\" -Recurse -Force
  Copy-Item "MANUAL_COPY_FILES\phase5-payment-gateway\contractnest-api\*" -Destination "contractnest-api\" -Recurse -Force
  Copy-Item "MANUAL_COPY_FILES\phase5-payment-gateway\contractnest-ui\*" -Destination "contractnest-ui\" -Recurse -Force

Apply to Supabase:
  Re-run 011_payment_gateway_tables_rpc.sql in Supabase SQL Editor
  (process_payment_webhook RPC updated with improved link matching)
  Run 007_seed_payment_request_templates.sql in Supabase SQL Editor (T8)

Deploy Edge Functions:
  supabase functions deploy payment-gateway
  supabase functions deploy payment-webhook

Razorpay Webhook Configuration:
  In Razorpay Dashboard → Settings → Webhooks:
  URL: https://{project-ref}.supabase.co/functions/v1/payment-webhook/razorpay/{tenant_id}
  Events: payment.captured, payment.failed, payment_link.paid, order.paid
  Secret: Store in tenant integration credentials as "webhook_secret"
