═══════════════════════════════════════════════════════════════════════════════
BUSINESS MODEL PHASE 1 - DELIVERABLES 1, 2 & 3
═══════════════════════════════════════════════════════════════════════════════

Date: 2025-01-11
Branch: claude/init-submodules-businessmodel-YRGku
Author: Claude Code Session

═══════════════════════════════════════════════════════════════════════════════
FILES INCLUDED
═══════════════════════════════════════════════════════════════════════════════

1. contractnest-edge/supabase/migrations/business-model-v2/001_schema_evolution.sql
   Purpose: Evolve existing Business Model tables
   Status: APPLIED ✅

2. contractnest-edge/supabase/migrations/business-model-v2/002_new_tables.sql
   Purpose: Create new tables for Business Model Agent
   Status: APPLIED ✅

3. DELIVERABLE 3 - SPLIT INTO 3 FILES (due to is_tenant_admin dependency):

   3a. 003a_rpc_functions.sql
       Purpose: 12 RPC functions with race condition handling
       Status: PENDING
       Dependencies: None (can run first)

   3b. 003b_rls_and_helpers.sql
       Purpose: RLS policies + helper functions (excluding is_tenant_admin)
       Status: PENDING
       Dependencies: None (can run after 3a)

   3c. 003c_is_tenant_admin_fix.sql
       Purpose: Fix is_tenant_admin function (has v_audit_logs_detailed dependency)
       Status: PENDING - REQUIRES ATTENTION
       Warning: Uses DROP CASCADE - will drop v_audit_logs_detailed view
       Action: After running, recreate v_audit_logs_detailed view

═══════════════════════════════════════════════════════════════════════════════
DELIVERABLE 3: FUNCTIONS & RLS
═══════════════════════════════════════════════════════════════════════════════

PART A: DATABASE FUNCTIONS (RPC) - File: 003a_rpc_functions.sql
──────────────────────────────────────────────────────────────
1.  deduct_credits()            - Atomic deduction with FOR UPDATE NOWAIT
2.  add_credits()               - Atomic addition, creates record if needed
3.  reserve_credits()           - Reserve credits for pending operations
4.  release_reserved_credits()  - Release previously reserved credits
5.  aggregate_usage()           - Usage aggregation by billing period
6.  record_usage()              - Record usage events atomically
7.  get_credit_balance()        - Get credit balances for tenant
8.  check_credit_availability() - Check availability without deducting
9.  get_billing_status()        - Comprehensive billing status (bot-friendly)
10. get_billing_alerts()        - Get billing alerts for tenant
11. calculate_tiered_price()    - Calculate tiered pricing
12. process_credit_expiry()     - Expire credits past expiry date

PART B: RLS POLICIES - File: 003b_rls_and_helpers.sql
─────────────────────────────────────────────────────
Table                    | SELECT              | INSERT/UPDATE/DELETE
-------------------------|---------------------|------------------------
t_bm_product_config      | All (active only)   | Admin only
t_bm_credit_balance      | Own tenant + Admin  | Admin + Service role
t_bm_credit_transaction  | Own tenant + Admin  | Admin + Service role
t_bm_topup_pack          | All (active only)   | Admin only
t_contract_invoice       | Own tenant + Admin  | Own tenant + Admin
t_bm_billing_event       | Own tenant + Admin  | Admin + Service role

HELPER FUNCTIONS (in 003b)
──────────────────────────
- is_platform_admin()       - Check admin via t_tenants.is_admin (user's tenant)
- get_user_tenant_id()      - Get default tenant_id from t_user_tenants
- user_belongs_to_tenant()  - Check if user belongs to specific tenant

PART C: is_tenant_admin FIX - File: 003c_is_tenant_admin_fix.sql
────────────────────────────────────────────────────────────────
- is_tenant_admin()         - Check admin via t_user_tenants.is_admin
- WARNING: Has dependency on v_audit_logs_detailed view
- Uses DROP CASCADE - view must be recreated after

═══════════════════════════════════════════════════════════════════════════════
RACE CONDITION HANDLING
═══════════════════════════════════════════════════════════════════════════════

1. FOR UPDATE NOWAIT
   - Used in: deduct_credits(), reserve_credits()
   - Behavior: Fails immediately if row is locked
   - Returns: error_code = 'LOCK_CONFLICT'

2. FOR UPDATE SKIP LOCKED
   - Used in: process_credit_expiry()
   - Behavior: Skips locked rows (for batch processing)

3. Atomic Transactions
   - All balance changes happen within function transaction
   - Audit trail inserted in same transaction

═══════════════════════════════════════════════════════════════════════════════
COPY COMMANDS (Windows PowerShell)
═══════════════════════════════════════════════════════════════════════════════

# Navigate to project root
cd "D:\projects\core projects\ContractNest\contractnest-combined"

# Copy all Deliverable 3 migration files
Copy-Item "MANUAL_COPY_FILES\business-model-phase1\contractnest-edge\supabase\migrations\business-model-v2\003a_rpc_functions.sql" -Destination "contractnest-edge\supabase\migrations\business-model-v2\" -Force
Copy-Item "MANUAL_COPY_FILES\business-model-phase1\contractnest-edge\supabase\migrations\business-model-v2\003b_rls_and_helpers.sql" -Destination "contractnest-edge\supabase\migrations\business-model-v2\" -Force
Copy-Item "MANUAL_COPY_FILES\business-model-phase1\contractnest-edge\supabase\migrations\business-model-v2\003c_is_tenant_admin_fix.sql" -Destination "contractnest-edge\supabase\migrations\business-model-v2\" -Force
Copy-Item "MANUAL_COPY_FILES\business-model-phase1\contractnest-edge\supabase\migrations\business-model-v2\004_seed_product_configs.sql" -Destination "contractnest-edge\supabase\migrations\business-model-v2\" -Force

Write-Host "All migration files copied!" -ForegroundColor Green

═══════════════════════════════════════════════════════════════════════════════
DELIVERABLE 4: SEED PRODUCT CONFIGS
═══════════════════════════════════════════════════════════════════════════════

File: 004_seed_product_configs.sql

PRODUCTS CONFIGURED:
────────────────────
| Product      | Code         | Billing Model           |
|--------------|--------------|-------------------------|
| ContractNest | contractnest | Composite               |
| FamilyKnows  | familyknows  | Tiered Family           |
| Kaladristi   | kaladristi   | Subscription + Usage    |

CONTRACTNEST DETAILS:
  - Base fee: ₹500-1200/month (user tiers)
  - Storage: 40MB included, ₹0.50/MB overage
  - Contracts: ₹150-100/contract (tiered)
  - VaNi AI addon: ₹5000/month
  - Credits: Notifications (WhatsApp, SMS, Email)
  - 7 topup packs seeded

FAMILYKNOWS DETAILS:
  - Free tier: 1 user, 25 assets
  - Individual: ₹75/quarter
  - Family of 4: ₹200/month
  - Extended Family: ₹400/month
  - AI Assistant addon: ₹100/month

KALADRISTI DETAILS:
  - Base subscription: ₹100/month
  - AI Reports: ₹50/report
  - 3 AI report topup packs seeded

═══════════════════════════════════════════════════════════════════════════════
APPLY ORDER
═══════════════════════════════════════════════════════════════════════════════

1. Run 003a_rpc_functions.sql       → APPLIED ✅
2. Run 003b_rls_and_helpers.sql     → APPLIED ✅
3. Run 003c_is_tenant_admin_fix.sql → APPLIED ✅
4. Run 004_seed_product_configs.sql → PENDING

═══════════════════════════════════════════════════════════════════════════════
