═══════════════════════════════════════════════════
FIX: Contact Channels Data Consistency + Cockpit 400 Error + Error Code Mismatch + Contract Creation 400 Fix
═══════════════════════════════════════════════════

Branch: fix-contact-channels-consistency
Submodules Affected: contractnest-ui, contractnest-edge, contractnest-api

═══════════════════════════════════════════════════
FILES TO COPY
═══════════════════════════════════════════════════

CONTRACTNEST-UI (3 files):
────────────────────────────
1. src/utils/constants/channels.ts
   → Fixed formatChannelValue greedy regex (was stripping entire phone number)
   → Added normalizeCountryCode utility function
   → Smart country code stripping that validates local number length

2. src/components/contacts/forms/ContactChannelsSection.tsx
   → Edit mode now calls formatChannelValue on save (was missing - root cause of inconsistent values)
   → Phone input stripped of + character (matches Quick Add behavior)
   → Display logic handles both ISO and phone code country_code formats
   → Add channel normalizes country_code to ISO format

3. src/pages/admin/subscription-management/index.tsx
   → Added pagination controls (Prev/Next buttons + page numbers)
   → Stores totalPages from API pagination response
   → Page numbers use sliding window (max 5 visible) for many pages
   → Changing page updates filters.page → triggers loadData via useEffect
   → Backend already supported pagination (RPC, Edge, API) - only UI was missing

CONTRACTNEST-EDGE (4 files):
────────────────────────────
3. supabase/functions/_shared/contacts/contactValidation.ts
   → Added normalizeContactChannels() function - normalizes value and country_code before storage
   → Added country-specific phone validation (40+ countries with exact digit lengths)
   → Fixed classifications list to match contactService.ts (was missing buyer, seller, etc.)
   → WhatsApp now validated same as mobile/phone (was skipped before)
   → Phone min length changed from 10 to 7 (some countries have 8-digit numbers)

4. supabase/functions/_shared/contacts/contactService.ts
   → Calls normalizeContactChannels() before create RPC
   → Calls normalizeContactChannels() before update RPC
   → Single source of truth for data normalization at storage layer

5. supabase/functions/contracts/index.ts
   → Fixed handleCockpitSummary() - now calls get_contact_cockpit_summary RPC
   → Previous version had wrong column names (contact_id→buyer_id, title→block_name, etc.)
   → RPC handles all aggregation: contracts, events, LTV, health score in a single DB call
   → Routed via POST with action: 'cockpit_summary'

6. supabase/migrations/contracts/016_fix_create_contract_rpc.sql
   → CRITICAL: Restores create_contract_transaction RPC to correct version
   → Someone modified the RPC directly in the DB, adding reference to non-existent 't_contact_persons' table
   → This caused ALL contract creation to fail with 400 "relation t_contact_persons does not exist"
   → Fix: Re-applies the correct RPC from migration 014 (CREATE OR REPLACE overwrites broken version)

CONTRACTNEST-API (1 file):
────────────────────────────
7. src/controllers/contactController.ts
   → Fixed error code mismatch: now handles both 'NOT_FOUND' and 'CONTACT_NOT_FOUND'
   → Prevents incorrect 400 status when contact is genuinely not found (should be 404)

═══════════════════════════════════════════════════
URGENT: FIX CONTRACT CREATION (Run in Supabase SQL Editor)
═══════════════════════════════════════════════════

The create_contract_transaction RPC was modified directly in the database
to reference a non-existent table 't_contact_persons'. This breaks ALL
contract creation. To fix immediately:

1. Open Supabase Dashboard → SQL Editor
2. Copy the ENTIRE contents of:
   MANUAL_COPY_FILES\fix-contact-channels-consistency\contractnest-edge\supabase\migrations\contracts\016_fix_create_contract_rpc.sql
3. Paste and run it in the SQL Editor
4. Contract creation will work again immediately

═══════════════════════════════════════════════════
COPY COMMANDS (PowerShell)
═══════════════════════════════════════════════════

cd "D:\projects\core projects\ContractNest\contractnest-combined"

# UI files
Copy-Item "MANUAL_COPY_FILES\fix-contact-channels-consistency\contractnest-ui\src\utils\constants\channels.ts" -Destination "contractnest-ui\src\utils\constants\channels.ts" -Force
Copy-Item "MANUAL_COPY_FILES\fix-contact-channels-consistency\contractnest-ui\src\components\contacts\forms\ContactChannelsSection.tsx" -Destination "contractnest-ui\src\components\contacts\forms\ContactChannelsSection.tsx" -Force
Copy-Item "MANUAL_COPY_FILES\fix-contact-channels-consistency\contractnest-ui\src\pages\admin\subscription-management\index.tsx" -Destination "contractnest-ui\src\pages\admin\subscription-management\index.tsx" -Force

# Edge files
Copy-Item "MANUAL_COPY_FILES\fix-contact-channels-consistency\contractnest-edge\supabase\functions\_shared\contacts\contactValidation.ts" -Destination "contractnest-edge\supabase\functions\_shared\contacts\contactValidation.ts" -Force
Copy-Item "MANUAL_COPY_FILES\fix-contact-channels-consistency\contractnest-edge\supabase\functions\_shared\contacts\contactService.ts" -Destination "contractnest-edge\supabase\functions\_shared\contacts\contactService.ts" -Force
Copy-Item "MANUAL_COPY_FILES\fix-contact-channels-consistency\contractnest-edge\supabase\functions\contracts\index.ts" -Destination "contractnest-edge\supabase\functions\contracts\index.ts" -Force

# Migration file (for codebase tracking - must be run in Supabase SQL Editor)
Copy-Item "MANUAL_COPY_FILES\fix-contact-channels-consistency\contractnest-edge\supabase\migrations\contracts\016_fix_create_contract_rpc.sql" -Destination "contractnest-edge\supabase\migrations\contracts\016_fix_create_contract_rpc.sql" -Force

# API files
Copy-Item "MANUAL_COPY_FILES\fix-contact-channels-consistency\contractnest-api\src\controllers\contactController.ts" -Destination "contractnest-api\src\controllers\contactController.ts" -Force

Write-Host "All files copied!" -ForegroundColor Green
