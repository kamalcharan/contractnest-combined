================================================================================
COPY INSTRUCTIONS - Entities VaNi Loader + UI Cleanup + Backend Optimization
================================================================================
Branch: entities-vani-loader
Date: January 2026

SUBMODULES AFFECTED:
- contractnest-ui
- contractnest-edge

================================================================================
FILES TO COPY
================================================================================

FRONTEND (contractnest-ui):
-----------------------------

1. UnifiedLoader.tsx (Updated hybrid VaNi loader)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-ui/src/components/common/loaders/UnifiedLoader.tsx
   TO:   contractnest-ui/src/components/common/loaders/UnifiedLoader.tsx

2. contacts/index.tsx (Updated entities list page)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-ui/src/pages/contacts/index.tsx
   TO:   contractnest-ui/src/pages/contacts/index.tsx

BACKEND (contractnest-edge):
-----------------------------

3. contactService.ts (Optimized with RPC and DB-level pagination)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-edge/supabase/functions/_shared/contacts/contactService.ts
   TO:   contractnest-edge/supabase/functions/_shared/contacts/contactService.ts

4. get_contact_stats.sql (New RPC functions - MUST BE DEPLOYED TO SUPABASE)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-edge/supabase/RPC/contacts/get_contact_stats.sql
   TO:   contractnest-edge/supabase/RPC/contacts/get_contact_stats.sql

   ** IMPORTANT: This SQL file must be executed in Supabase SQL Editor to create the RPC functions **

================================================================================
CHANGES SUMMARY
================================================================================

UnifiedLoader.tsx:
- Updated VaNiLoader with hybrid approach (orb + dimmed skeletons)
- Added dark orb background (#1e293b) for brand consistency
- Added showSkeleton, skeletonVariant, skeletonCount props
- Added dimmed prop to ContentSkeleton for 40% opacity
- Updated animations: vani-orb-pulse, skeleton-shimmer
- SectionLoader now defaults to variant='vani' with skeletons

contacts/index.tsx - LOADER CHANGES:
- Changed import from ContentSkeleton to VaNiLoader
- Renamed EntitySkeleton to EntityLoader
- Added getLoadingMessage() for dynamic context messages
- Loading now shows: "VaNi is Loading Entities..." or "VaNi is Loading Buyers..." etc.

contacts/index.tsx - UI CLEANUP CHANGES:
- REMOVED: Classifications filter from advanced filters dropdown
- REMOVED: "Select all" checkbox above the list
- REMOVED: Checkbox from grid view cards
- REMOVED: Checkbox from list view cards
- REMOVED: MoreHorizontal (...) button from grid view cards
- REMOVED: MoreHorizontal (...) button from list view cards
- REMOVED: isSelected ring styling from both card types
- ADDED: Trash2 delete button to grid view cards (soft delete/archive)
- ADDED: Trash2 delete button to list view cards (soft delete/archive)
- ADDED: handleSoftDelete function using useUpdateContactStatus hook
- ADDED: useUpdateContactStatus hook import
- REMOVED: MoreHorizontal, CheckSquare from lucide-react imports

contactService.ts - BACKEND OPTIMIZATION:
- OPTIMIZED: listContacts() now uses RPC for DB-level pagination and filtering
- OPTIMIZED: getContactStats() now uses RPC for single-query statistics
- ADDED: Fallback to JS-based filtering when RPC is unavailable
- REMOVED: Duplicate applyClassificationFilter method definitions
- ADDED: enrichContactsWithRelatedData() helper method
- ADDED: listContactsFallback() for backwards compatibility
- ADDED: getContactStatsFallback() for backwards compatibility
- IMPROVED: When no classification filter, uses .range() for DB-level pagination

get_contact_stats.sql - NEW RPC FUNCTIONS:
- CREATED: get_contact_stats() - Returns all counts in single SQL query
  * Uses COUNT with FILTER for efficient statistics
  * Supports optional type, search, and classifications filters
  * Uses JSONB ? operator for classification matching
- CREATED: list_contacts_filtered() - DB-level pagination and filtering
  * Applies all filters at database level
  * Uses LIMIT/OFFSET instead of JS slice
  * Uses ?| operator for "any of" classification matching
  * Supports dynamic sorting
  * Returns paginated results with total count

================================================================================
POWERSHELL COPY COMMANDS
================================================================================

cd "D:\projects\core projects\ContractNest\contractnest-combined"

# ===== FRONTEND FILES =====

# Copy loader component
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-ui\src\components\common\loaders\UnifiedLoader.tsx" -Destination "contractnest-ui\src\components\common\loaders\UnifiedLoader.tsx" -Force

# Copy contacts page
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-ui\src\pages\contacts\index.tsx" -Destination "contractnest-ui\src\pages\contacts\index.tsx" -Force

# ===== BACKEND FILES =====

# Copy optimized contactService
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-edge\supabase\functions\_shared\contacts\contactService.ts" -Destination "contractnest-edge\supabase\functions\_shared\contacts\contactService.ts" -Force

# Copy RPC SQL file (for reference - must deploy to Supabase)
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-edge\supabase\RPC\contacts\get_contact_stats.sql" -Destination "contractnest-edge\supabase\RPC\contacts\get_contact_stats.sql" -Force

Write-Host "Files copied successfully!" -ForegroundColor Green
Write-Host ""
Write-Host "IMPORTANT: You must also deploy the SQL file to Supabase!" -ForegroundColor Yellow
Write-Host "Open Supabase SQL Editor and run the contents of:" -ForegroundColor Yellow
Write-Host "contractnest-edge\supabase\RPC\contacts\get_contact_stats.sql" -ForegroundColor Yellow

================================================================================
SUPABASE RPC DEPLOYMENT
================================================================================

IMPORTANT: After copying files, you must deploy the RPC functions to Supabase:

1. Open Supabase Dashboard
2. Go to SQL Editor
3. Copy the contents of: contractnest-edge/supabase/RPC/contacts/get_contact_stats.sql
4. Execute the SQL
5. Verify functions are created:
   - get_contact_stats
   - list_contacts_filtered

The backend code has fallbacks, so it will work without the RPC functions,
but performance will be the same as before. Deploy the RPC for full optimization.

================================================================================
TESTING CHECKLIST
================================================================================

LOADER TESTS:
- [ ] Navigate to /contacts (Entities page)
- [ ] Verify VaNi orb appears with dark background (#1e293b)
- [ ] Verify Sparkles icon inside orb with theme primary color
- [ ] Verify pulse ring animates around orb
- [ ] Verify message: "VaNi is Loading Entities..." (uppercase, pulsing)
- [ ] Verify dimmed skeleton cards appear below orb (40% opacity)
- [ ] Click "Buyers" filter → message changes to "VaNi is Loading Buyers..."
- [ ] Toggle Grid/List view → skeleton variant changes accordingly

UI CLEANUP TESTS:
- [ ] Verify NO classifications filter in advanced filters dropdown
- [ ] Verify NO "Select all" checkbox above the list
- [ ] Verify NO checkbox in grid view cards
- [ ] Verify NO checkbox in list view cards
- [ ] Verify NO "..." (more options) button in cards
- [ ] Verify Trash icon (delete) button appears in grid view cards
- [ ] Verify Trash icon (delete) button appears in list view cards
- [ ] Click Trash icon → shows "Archiving..." toast → entity archived
- [ ] Verify archived entity disappears from list (default shows active only)

THEME TESTS:
- [ ] Test dark mode - all icons use proper theme colors
- [ ] Test light mode - orb provides good contrast
- [ ] Verify Eye, Edit, FileText, Trash2 icons have proper theme colors

PERFORMANCE TESTS (after RPC deployment):
- [ ] Check browser DevTools Network tab for API response times
- [ ] Verify list loads faster than before (~1-2 seconds vs 6 seconds)
- [ ] Check console logs for "Using optimized RPC" messages
- [ ] Test pagination - should NOT fetch all data on each page
- [ ] Test with classification filter - verify it still works
- [ ] Test stats endpoint - should be faster (single query vs multiple)

FALLBACK TESTS (if RPC not deployed):
- [ ] Verify list still works (fallback to JS filtering)
- [ ] Check console for "RPC not available, falling back" warnings
- [ ] Verify all filters still work correctly

================================================================================
