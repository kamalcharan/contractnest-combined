================================================================================
COPY INSTRUCTIONS - Entities VaNi Loader + UI Cleanup + Backend Optimization
================================================================================
Branch: entities-vani-loader
Date: January 2026
Session: UI Fixes - Theme, Loader, Header, UX

SUBMODULES AFFECTED:
- contractnest-ui
- contractnest-edge

================================================================================
FILES TO COPY
================================================================================

FRONTEND (contractnest-ui):
-----------------------------

1. UnifiedLoader.tsx (Hybrid VaNi loader)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-ui/src/components/common/loaders/UnifiedLoader.tsx
   TO:   contractnest-ui/src/components/common/loaders/UnifiedLoader.tsx

2. contacts/index.tsx (Entities list page with VaNi loader + UI cleanup)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-ui/src/pages/contacts/index.tsx
   TO:   contractnest-ui/src/pages/contacts/index.tsx

3. contacts/create.tsx (Create/Edit Entity page - UPDATED)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-ui/src/pages/contacts/create.tsx
   TO:   contractnest-ui/src/pages/contacts/create.tsx

   NEW CHANGES:
   - Header: "Edit Contact" → "Edit Entity"
   - Button: "Update Contact" → "Update Entity"
   - Loader: FullPageSaveLoader now uses VaNi orb style with Sparkles icon
   - Loader message: "Updating contact..." → "Updating Entity..."
   - Added "Unsaved changes" indicator (yellow pulsing badge)

4. useContacts.ts (API hooks - UPDATED)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-ui/src/hooks/useContacts.ts
   TO:   contractnest-ui/src/hooks/useContacts.ts

   NEW CHANGES:
   - Fixed 404 error: PATCH endpoint now calls /api/contacts/:id/status instead of /api/contacts/:id

5. ContactChannelsSection.tsx (Form component - UPDATED)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-ui/src/components/contacts/forms/ContactChannelsSection.tsx
   TO:   contractnest-ui/src/components/contacts/forms/ContactChannelsSection.tsx

   NEW CHANGES:
   - Buttons now use inline styles with colors.brand.primary (theme-aware)
   - Removed misleading "Channel Added" / "Channel Removed" toasts
   - Added currentTheme from useTheme for proper color access

6. AddressesSection.tsx (Form component - UPDATED)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-ui/src/components/contacts/forms/AddressesSection.tsx
   TO:   contractnest-ui/src/components/contacts/forms/AddressesSection.tsx

   NEW CHANGES:
   - Buttons now use inline styles with colors.brand.primary (theme-aware)
   - Removed misleading "Address added" / "Address removed" toasts
   - Added currentTheme from useTheme for proper color access

7. ContactClassificationSelector.tsx (Form component - THEME FIXED)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-ui/src/components/contacts/forms/ContactClassificationSelector.tsx
   TO:   contractnest-ui/src/components/contacts/forms/ContactClassificationSelector.tsx

   NEW CHANGES (LATEST SESSION):
   - FIXED: Selection border now uses theme colors (colors.brand.primary) instead of Tailwind border-primary
   - FIXED: Checkmark circle uses theme colors instead of Tailwind bg-primary
   - All styling is now theme-aware and changes when theme changes
   - Removed misleading "Classification Added" / "Classification Removed" toasts
   - Info message box now uses theme brand colors

ADDITIONAL CHANGES TO ContactChannelsSection.tsx (LATEST SESSION):
   - FIXED: Mobile/phone input validation - now strips non-numeric characters on input
   - Characters like letters are immediately removed from phone fields
   - Only allows digits and optional + at start for phone numbers

BACKEND (contractnest-edge):
-----------------------------

7. contactService.ts (Optimized with RPC)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-edge/supabase/functions/_shared/contacts/contactService.ts
   TO:   contractnest-edge/supabase/functions/_shared/contacts/contactService.ts

8. get_contact_stats.sql (RPC functions - DEPLOY TO SUPABASE)
   FROM: MANUAL_COPY_FILES/entities-vani-loader/contractnest-edge/supabase/RPC/contacts/get_contact_stats.sql
   TO:   contractnest-edge/supabase/RPC/contacts/get_contact_stats.sql

================================================================================
CHANGES SUMMARY - THIS SESSION
================================================================================

1. HEADER/BUTTON TEXT CHANGES:
   - "Edit Contact" → "Edit Entity"
   - "Update Contact" → "Update Entity"
   - "Creating contact..." → "Creating Entity..."
   - "Updating contact..." → "Updating Entity..."

2. API FIX (404 ERROR):
   - useUpdateContactStatus hook was calling PATCH /api/contacts/:id
   - Fixed to call PATCH /api/contacts/:id/status (matching API route)

3. VANI LOADER FOR UPDATE:
   - FullPageSaveLoader replaced with VaNi orb style
   - Dark orb (#1e293b) with Sparkles icon
   - Theme-colored pulse ring (colors.brand.primary)
   - "VaNi is processing..." message

4. COMPONENT THEME FIX:
   - "Add Channel" buttons now use colors.brand.primary (not bg-primary Tailwind)
   - "Add Address" buttons now use colors.brand.primary
   - Cancel buttons use theme colors for border/text
   - Buttons will now change color when theme changes

5. UX IMPROVEMENTS:
   - Added "Unsaved changes" indicator near save button (yellow pulsing badge)
   - Removed misleading success toasts for in-form additions:
     - No more "Channel Added" toast
     - No more "Channel Removed" toast
     - No more "Address added" toast
     - No more "Address removed" toast
     - No more "Classification Added" toast
     - No more "Classification Removed" toast
   - User now sees the indicator instead, making it clear data isn't saved yet

6. CLASSIFICATION SELECTOR THEME FIX (LATEST SESSION):
   - Selection border now uses inline styles with colors.brand.primary
   - Checkmark circle uses colors.brand.primary (theme-aware)
   - When theme changes (e.g., from blue to red), all UI elements update

7. MOBILE/PHONE INPUT VALIDATION (LATEST SESSION):
   - Phone input fields now strip non-numeric characters on typing
   - Only digits and + (at start) are allowed
   - Prevents user from entering letters/special characters in phone numbers

8. 500 ERROR INVESTIGATION:
   - The 500 error on update likely originates in the backend RPC function
   - The frontend data transformation looks correct
   - To debug: Check Supabase logs for 'update_contact_transaction' RPC errors
   - Ensure all RPC functions are deployed to Supabase

================================================================================
POWERSHELL COPY COMMANDS
================================================================================

cd "D:\projects\core projects\ContractNest\contractnest-combined"

# ===== FRONTEND FILES =====

# Copy loader component
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-ui\src\components\common\loaders\UnifiedLoader.tsx" -Destination "contractnest-ui\src\components\common\loaders\UnifiedLoader.tsx" -Force

# Copy contacts pages
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-ui\src\pages\contacts\index.tsx" -Destination "contractnest-ui\src\pages\contacts\index.tsx" -Force
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-ui\src\pages\contacts\create.tsx" -Destination "contractnest-ui\src\pages\contacts\create.tsx" -Force

# Copy hooks
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-ui\src\hooks\useContacts.ts" -Destination "contractnest-ui\src\hooks\useContacts.ts" -Force

# Copy form components
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-ui\src\components\contacts\forms\ContactChannelsSection.tsx" -Destination "contractnest-ui\src\components\contacts\forms\ContactChannelsSection.tsx" -Force
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-ui\src\components\contacts\forms\AddressesSection.tsx" -Destination "contractnest-ui\src\components\contacts\forms\AddressesSection.tsx" -Force
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-ui\src\components\contacts\forms\ContactClassificationSelector.tsx" -Destination "contractnest-ui\src\components\contacts\forms\ContactClassificationSelector.tsx" -Force

# ===== BACKEND FILES =====

# Copy optimized contactService
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-edge\supabase\functions\_shared\contacts\contactService.ts" -Destination "contractnest-edge\supabase\functions\_shared\contacts\contactService.ts" -Force

# Copy RPC SQL file
Copy-Item "MANUAL_COPY_FILES\entities-vani-loader\contractnest-edge\supabase\RPC\contacts\get_contact_stats.sql" -Destination "contractnest-edge\supabase\RPC\contacts\get_contact_stats.sql" -Force

Write-Host "Files copied successfully!" -ForegroundColor Green

================================================================================
TESTING CHECKLIST - THIS SESSION
================================================================================

HEADER/BUTTON TEXT:
- [ ] Navigate to /contacts/:id/edit
- [ ] Verify page title shows "Edit Entity" (not "Edit Contact")
- [ ] Verify button shows "Update Entity" (not "Update Contact")

ARCHIVE/DELETE FIX:
- [ ] Go to /contacts (Entities list)
- [ ] Click Trash icon on any entity card
- [ ] Verify entity is archived (no 404 error)
- [ ] Check console - should show successful status update

VANI LOADER:
- [ ] Navigate to /contacts (Entities list)
- [ ] Verify VaNi orb loader appears during initial load
- [ ] Edit an entity and click "Update Entity"
- [ ] Verify VaNi orb loader appears (dark orb, sparkles, pulsing)
- [ ] Verify message shows "Updating Entity..."

COMPONENT THEME:
- [ ] Go to Create/Edit Entity page
- [ ] Check "Add Channel" button color matches theme's brand color
- [ ] Check "Add Address" button color matches theme's brand color
- [ ] Switch themes - verify buttons change color accordingly

UX - UNSAVED CHANGES:
- [ ] Open Edit Entity page
- [ ] Make a change (add channel, edit name, etc.)
- [ ] Verify "Unsaved changes" yellow badge appears near save button
- [ ] Verify NO toast appears when adding channel/address
- [ ] Click "Update Entity" to save
- [ ] Verify badge disappears after save

CLASSIFICATION SELECTOR THEME (LATEST SESSION):
- [ ] Go to Create/Edit Entity page
- [ ] In red theme: Verify classification selection border shows RED (not blue)
- [ ] Verify checkmark circle is RED when selected
- [ ] Switch to blue theme - verify elements change to blue
- [ ] Switch to green theme - verify elements change to green
- [ ] Verify NO toasts appear when toggling classifications

MOBILE/PHONE INPUT VALIDATION (LATEST SESSION):
- [ ] Go to Create/Edit Entity page
- [ ] Click "Add Channel" and select "Mobile" type
- [ ] Try typing letters (e.g., "abc") - verify they are NOT entered
- [ ] Type only digits (e.g., "9876543210") - verify they ARE entered
- [ ] Type + at start - verify it's allowed (e.g., "+91")
- [ ] Test same with WhatsApp channel type

================================================================================
PREVIOUS SESSION TESTING (still applicable)
================================================================================

LOADER TESTS:
- [ ] Navigate to /contacts (Entities page)
- [ ] Verify VaNi orb appears with dark background (#1e293b)
- [ ] Verify Sparkles icon inside orb with theme primary color
- [ ] Verify pulse ring animates around orb
- [ ] Verify message: "VaNi is Loading Entities..." (uppercase, pulsing)
- [ ] Verify dimmed skeleton cards appear below orb (40% opacity)

UI CLEANUP TESTS:
- [ ] Verify NO classifications filter in advanced filters dropdown
- [ ] Verify NO "Select all" checkbox above the list
- [ ] Verify NO checkbox in grid/list view cards
- [ ] Verify NO "..." (more options) button in cards
- [ ] Verify Trash icon (delete) button appears in cards

PERFORMANCE TESTS (after RPC deployment):
- [ ] Check browser DevTools Network tab for API response times
- [ ] Verify list loads faster than before (~1-2 seconds vs 6 seconds)

================================================================================
