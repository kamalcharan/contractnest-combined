================================================================================
BUSINESS MODEL PHASE 2 - COPY INSTRUCTIONS
================================================================================
Date: January 2026 (Updated)
Phase: Phase 2 - Billing Edge Function & API Layer (TESTED)

================================================================================
FILES TO COPY
================================================================================

0. CONSOLIDATED MIGRATION (PREFERRED - Apply to Supabase)
   Source: MANUAL_COPY_FILES/business-model-phase2/final_phase2_migration.sql
   Action: Run in Supabase SQL Editor - contains ALL 9 RPC functions with proper DROP statements
   Note: This is the recommended migration file - includes all fixes from testing

1. DATABASE MIGRATION (Individual file - already included in final_phase2_migration.sql)
   Source: MANUAL_COPY_FILES/business-model-phase2/contractnest-edge/supabase/migrations/business-model-v2/005_phase2_rpc_functions.sql
   Destination: contractnest-edge/supabase/migrations/business-model-v2/005_phase2_rpc_functions.sql
   Action: Copy file, then run migration in Supabase SQL Editor

2. EDGE FUNCTION (Deploy to Supabase)
   Source: MANUAL_COPY_FILES/business-model-phase2/contractnest-edge/supabase/functions/billing/index.ts
   Destination: contractnest-edge/supabase/functions/billing/index.ts
   Action: Copy file, then deploy: supabase functions deploy billing

3. API TYPES
   Source: MANUAL_COPY_FILES/business-model-phase2/contractnest-api/src/types/billing.dto.ts
   Destination: contractnest-api/src/types/billing.dto.ts

4. API VALIDATORS
   Source: MANUAL_COPY_FILES/business-model-phase2/contractnest-api/src/validators/billingValidators.ts
   Destination: contractnest-api/src/validators/billingValidators.ts

5. API SERVICE
   Source: MANUAL_COPY_FILES/business-model-phase2/contractnest-api/src/services/billingService.ts
   Destination: contractnest-api/src/services/billingService.ts

6. API CONTROLLER
   Source: MANUAL_COPY_FILES/business-model-phase2/contractnest-api/src/controllers/billingController.ts
   Destination: contractnest-api/src/controllers/billingController.ts

7. API ROUTES
   Source: MANUAL_COPY_FILES/business-model-phase2/contractnest-api/src/routes/billingRoutes.ts
   Destination: contractnest-api/src/routes/billingRoutes.ts

8. DOCUMENTATION - PRD ADDENDUM
   Source: MANUAL_COPY_FILES/business-model-phase2/ClaudeDocumentation/BusinessModel/PRD_ADDENDUM_ARCHITECTURE.md
   Destination: ClaudeDocumentation/BusinessModel/PRD_ADDENDUM_ARCHITECTURE.md

9. DOCUMENTATION - DELIVERY TRACKER (Updated)
   Source: MANUAL_COPY_FILES/business-model-phase2/ClaudeDocumentation/BusinessModel/BM_delivery.md
   Destination: ClaudeDocumentation/BusinessModel/BM_delivery.md

10. DOCUMENTATION - HANDOVER (Updated)
    Source: MANUAL_COPY_FILES/business-model-phase2/ClaudeDocumentation/BusinessModel/HANDOVER_CONTEXT.md
    Destination: ClaudeDocumentation/BusinessModel/HANDOVER_CONTEXT.md

================================================================================
SUBMODULES AFFECTED
================================================================================
- contractnest-edge (migration + Edge function)
- contractnest-api (types, validators, service, controller, routes)
- ClaudeDocumentation (PRD addendum, delivery tracker, handover)

================================================================================
POST-COPY: REGISTER BILLING ROUTES IN API
================================================================================

File: contractnest-api/src/index.ts

STEP 1: Add route loading block (around line 286, after catalogStudioRoutes loading)
------------------------------------------------------------------------
// Load Billing routes with error handling
let billingRoutes;
try {
  billingRoutes = require('./routes/billingRoutes').default;
  console.log('‚úÖ Billing routes loaded');
} catch (error) {
  console.error('‚ùå Failed to load billing routes:', error);
  if (process.env.NODE_ENV === 'production') {
    process.exit(1);
  } else {
    console.warn('‚ö†Ô∏è  Continuing without billing routes...');
    billingRoutes = null;
  }
}

STEP 2: Add route registration (around line 615, after onboarding routes)
------------------------------------------------------------------------
// Register Billing routes with error handling
try {
  if (billingRoutes) {
    app.use('/api', billingRoutes);
    console.log('‚úÖ Billing routes registered at /api');
  } else {
    console.log('‚ö†Ô∏è  Billing routes skipped (not loaded)');
  }
} catch (error) {
  console.error('‚ùå Failed to register billing routes:', error);
  captureException(error instanceof Error ? error : new Error(String(error)), {
    tags: { source: 'route_registration', route_type: 'billing' }
  });
}

STEP 3: Add to health check services (around line 641)
------------------------------------------------------------------------
Add to the services object:
  billing: billingRoutes ? 'loaded' : 'not_loaded',

Add to the features object (around line 655):
  billing_api: billingRoutes !== null,

STEP 4: Add billing service health check (around line 750, after catalogStudio check)
------------------------------------------------------------------------
// Check billing service health if available
if (billingRoutes) {
  try {
    healthData.services.billing = 'healthy';
  } catch (error) {
    healthData.services.billing = 'error';
  }
}

STEP 5: Add to root endpoint services (around line 784)
------------------------------------------------------------------------
Add to the services object:
  billing: billingRoutes ? 'available' : 'not_available',

Add to the endpoints object (around line 795):
  billing: '/api/billing',

STEP 6: Add startup logging (around line 1156, after catalog studio logging)
------------------------------------------------------------------------
// Log billing routes if available
if (billingRoutes) {
  console.log('üìç Billing routes:');
  console.log('- GET    /api/billing/status/:tenantId              # Billing status (bot-friendly)');
  console.log('- GET    /api/billing/subscription/:tenantId        # Subscription details');
  console.log('- GET    /api/billing/credits/:tenantId             # Credit balances');
  console.log('- GET    /api/billing/usage/:tenantId               # Usage summary');
  console.log('- GET    /api/billing/invoice-estimate/:tenantId    # Invoice estimate');
  console.log('- GET    /api/billing/alerts/:tenantId              # Billing alerts');
  console.log('- GET    /api/billing/topup-packs                   # Available topup packs');
  console.log('- POST   /api/billing/usage                         # Record usage event');
  console.log('- POST   /api/billing/credits/deduct                # Deduct credits');
  console.log('- POST   /api/billing/credits/add                   # Add credits');
  console.log('- POST   /api/billing/credits/topup                 # Purchase topup');
  console.log('- POST   /api/billing/credits/check                 # Check availability');
  console.log('üìã Billing API features:');
  console.log('  ‚úÖ Comprehensive billing status for bot/AI integration');
  console.log('  ‚úÖ Credit balance management with atomic operations');
  console.log('  ‚úÖ Usage tracking and aggregation');
  console.log('  ‚úÖ Invoice estimation with line items');
  console.log('  ‚úÖ Topup pack purchase flow');
  console.log('  ‚úÖ Credit availability checking');
  console.log('  ‚úÖ Multi-tenant with RLS policies');
  console.log('  ‚úÖ Edge function integration (single RPC calls)');
} else {
  console.log('‚ö†Ô∏è  Billing routes not available');
}

================================================================================
APPLY SQL MIGRATION TO SUPABASE
================================================================================

1. Open Supabase Dashboard ‚Üí SQL Editor
2. Copy contents of:
   contractnest-edge/supabase/migrations/business-model-v2/005_phase2_rpc_functions.sql
3. Run the SQL

================================================================================
DEPLOY EDGE FUNCTION
================================================================================

cd contractnest-edge
supabase functions deploy billing
cd ..

================================================================================
TESTING CHECKLIST
================================================================================
- [ ] SQL migration runs without errors
- [ ] Edge function deploys successfully
- [ ] API starts without TypeScript errors
- [ ] Routes registered (check startup logs for "Billing routes registered")
- [ ] Health check includes billing service
- [ ] GET /api/billing/topup-packs returns packs
- [ ] GET /api/billing/status/:tenantId returns data (with valid tenant)
- [ ] POST /api/billing/credits/check works

================================================================================
