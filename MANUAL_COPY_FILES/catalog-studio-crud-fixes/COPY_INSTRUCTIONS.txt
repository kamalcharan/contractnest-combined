â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ CATALOG STUDIO CRUD FIXES - PRODUCTION READY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Branch: catalog-studio-crud-fixes
Date: 2026-01-09 (Updated)

Files Changed:
  FRONTEND (contractnest-ui):
  - src/utils/catalog-studio/wizard-data.ts - Added ResourceDependencyStep, PricingStep
  - src/utils/catalog-studio/catBlockAdapter.ts - Complete rewrite with all field mappings
  - src/utils/catalog-studio/htmlUtils.ts - NEW: HTML sanitization utilities
  - src/utils/catalog-studio/index.ts - Added htmlUtils exports
  - src/components/catalog-studio/BlockWizard/index.tsx - Wired all wizard steps
  - src/components/catalog-studio/BlockWizard/BlockWizardContent.tsx - Wired all wizard steps
  - src/components/catalog-studio/SafeHtml.tsx - NEW: Safe HTML rendering component
  - src/hooks/queries/useCatBlocks.ts - Updated CatBlock interface
  - src/pages/catalog-studio/configure.tsx - Fixed to use adapters properly

  EDGE FUNCTION (contractnest-edge):
  - supabase/functions/cat-blocks/index.ts - Added is_live field support

  DATABASE MIGRATION (contractnest-edge):
  - supabase/migrations/catalog-studio/006_add_is_live_column.sql - NEW: Add is_live column

Submodules Affected: contractnest-ui, contractnest-edge

Production Checklist:
  âœ… Transaction Management: N/A (frontend changes)
  âœ… Race Condition Handling: N/A (frontend changes)
  âœ… Error Handling: Yes - validation in wizard steps
  âœ… Toasts: Uses existing toast system
  âœ… Loaders: Uses existing loader system

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
KEY CHANGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ResourceDependencyStep restored (Step 3 for service blocks)
   - Independent vs Resource-based pricing selection now works

2. BusinessRulesStep wired (Step 7 for service blocks)

3. PricingStep added for spare blocks (Step 4)

4. catBlockAdapter completely rewritten:
   - All wizard fields now properly saved to database
   - Correct field names (type, pricing_mode, base_price, etc.)
   - Type-specific config builders for each block type
   - Default status = 'active'
   - getField() helper checks both top-level AND meta fields
   - extractPrimaryPrice checks both locations for price data

5. HTML sanitization utilities added:
   - stripHtml, sanitizeHtml, truncateText, etc.
   - SafeHtml component for rendering HTML descriptions

6. configure.tsx Production-Ready Fixes:
   - Uses blockToCreateData/blockToUpdateData adapters
   - Passes userId from user?.id (AuthContext)
   - Passes isLive from AuthContext
   - Passes sequenceNo for ordering
   - All CRUD operations properly mapped

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FIELDS NOW SAVED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Top-level DB fields:
  âœ… name, type, block_type_id, category
  âœ… display_name, icon, description, tags
  âœ… base_price, currency, pricing_mode_id
  âœ… tax_rate, hsn_sac_code
  âœ… resource_pricing (for resource-based blocks)
  âœ… visible, is_admin
  âœ… sequence_no, is_live
  âœ… created_by, updated_by

Config JSONB (type-specific):
  âœ… Service: duration, deliveryMode, serviceCycles, evidence, sla, etc.
  âœ… Spare: sku, hsn, brand, inventory, fulfillment, warranty
  âœ… Billing: paymentType, installments, schedule, lateFee
  âœ… Text: content, contentType, requireAcceptance
  âœ… All: pricingRecords, resourcePricingRecords, selectedResources

NOTE: price_type_id and status_id expect UUIDs in DB
      - Stored as strings in config.priceType and config.status instead

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DATABASE MIGRATION REQUIRED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Run this migration to add is_live column:

  supabase/migrations/catalog-studio/006_add_is_live_column.sql

Or run directly in Supabase SQL editor:

  ALTER TABLE cat_blocks
  ADD COLUMN IF NOT EXISTS is_live BOOLEAN NOT NULL DEFAULT true;

  CREATE INDEX IF NOT EXISTS idx_cat_blocks_is_live ON cat_blocks(is_live);

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EDGE FUNCTION DEPLOYMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

After copying the edge function, deploy to Supabase:

  cd contractnest-edge
  supabase functions deploy cat-blocks
