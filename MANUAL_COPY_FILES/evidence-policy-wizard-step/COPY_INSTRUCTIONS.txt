===============================================================
STEP 2: Evidence Policy Step in Contract Wizard
Branch: evidence-policy-wizard-step
Date: 2025-02-10
===============================================================

CHANGES SUMMARY
---------------
Adds a new "Evidence Policy" step in the contract wizard between
Billing View and Events Preview. The wizard now has 10 steps:

  Path > Acceptance > Counterparty > Details > BillingCycle >
  Blocks > BillingView > **Evidence Policy** > Events Preview > Review

Users select one of three evidence policies:
  - No Verification: No evidence needed during service execution
  - Upload Proof: Photos/documents uploaded as proof of work
  - Smart Form: Structured digital forms during service execution

When "Smart Form" is selected, a form picker appears with:
  - Dropdown of tenant-bookmarked forms (via useSmartFormSelections)
  - Drag-to-reorder table with sort numbers, version, category
  - Remove button per form

Info banner explains:
  - Smart forms appear in the service execution drawer
  - For custom smart forms, contact Product Admin

Also REVERTS the Evidence Policy from the contract detail Evidence tab
(that was incorrectly placed there earlier).

Submodules Affected: contractnest-ui ONLY

Files Changed:
  1. contractnest-ui/src/components/contracts/ContractWizard/steps/EvidencePolicyStep.tsx (NEW)
     - Full wizard step with 3 landscape option cards
     - Smart form picker dropdown + drag-to-reorder table
     - Info banner with smart forms explanation

  2. contractnest-ui/src/components/contracts/ContractWizard/index.tsx (MODIFIED)
     - Added EvidencePolicyStep import
     - Added 'evidencePolicy' to StepId union
     - Added step to CONTRACT_STEPS array (between billingView and events)
     - Added evidencePolicyType + evidenceSelectedForms to ContractWizardState
     - Added to createInitialWizardState (defaults: 'none', [])
     - Added validation case (always valid)
     - Added renderStepContent case with state callbacks
     - Added evidence_policy_type + evidence_selected_forms to mapWizardToRequest

  REVERTED:
  - contractnest-ui/src/pages/contracts/detail/index.tsx — NO CHANGES NEEDED
    (the previous EvidencePolicySection was never copied to local, so no revert needed)

Production Checklist:
  - Transaction Management: N/A (frontend wizard step, API handles persistence)
  - Race Condition Handling: Yes (useRef guard in useSmartFormSelections)
  - Error Handling: Yes (hook error states, graceful fallback)
  - Toasts: N/A (wizard handles success/error on submit)
  - Loaders: Yes (loading spinner in Add Form button)

===============================================================
COPY COMMANDS (PowerShell)
===============================================================

cd "D:\projects\core projects\ContractNest\contractnest-combined"

xcopy "MANUAL_COPY_FILES\evidence-policy-wizard-step\contractnest-ui" "contractnest-ui" /S /Y

===============================================================
TESTING CHECKLIST
===============================================================
- [ ] Open contract wizard (Create Contract)
- [ ] Go through steps: Path > Acceptance > Counterparty > Details > BillingCycle > Blocks > BillingView
- [ ] After BillingView, next step should be "Evidence Policy"
- [ ] 3 horizontal cards displayed: No Verification, Upload Proof, Smart Form
- [ ] "No Verification" is selected by default
- [ ] Click each card — selection checkmark moves correctly
- [ ] Info banner visible: smart forms explanation + "contact Product Admin"
- [ ] Select "Smart Form" — form selector section appears below
- [ ] Click "Add Form" — dropdown shows tenant bookmarked forms
- [ ] Add a form — appears in table with drag handle
- [ ] Add second form — drag to reorder, sort numbers update
- [ ] Remove form — click X, sort numbers reflow
- [ ] Click Next — goes to Events Preview (step 9)
- [ ] Click Back from Events Preview — returns to Evidence Policy
- [ ] Complete wizard — verify evidence_policy_type in API request payload
- [ ] Evidence tab in contract detail should show ONLY collected evidence (no policy section)

===============================================================
WAITING FOR CONFIRMATION
===============================================================
Test locally and confirm:
  -> "Tested, working - proceed with Step 3 (service drawer redesign)"
  -> "Issue found: [describe problem]"
===============================================================
